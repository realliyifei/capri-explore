# Modeling baryonic physics in future weak lensing surveys

CorpusID: 119391718
 
tags: #Physics

URL: [https://www.semanticscholar.org/paper/36492cae34a9d3e8b0cdb3ff9f95114aeef5b2a2](https://www.semanticscholar.org/paper/36492cae34a9d3e8b0cdb3ff9f95114aeef5b2a2)
 
| Is Survey?        | Result          |
| ----------------- | --------------- |
| By Classifier     | False |
| By Annotator      | (Not Annotated) |

---

Modeling baryonic physics in future weak lensing surveys
2018

Hung-Jin Huang 
McWilliams Center for Cosmology
Department of Physics
Carnegie Mellon University
15213PittsburghPAUSA

Tim Eifler 
Steward Observatory/Department of Astronomy
University of Arizona
933 North Cherry Avenue85721TucsonAZUSA

Jet Propulsion Laboratory
California Institute of Technology
91109PasadenaCAUSA

Rachel Mandelbaum 
McWilliams Center for Cosmology
Department of Physics
Carnegie Mellon University
15213PittsburghPAUSA

Scott Dodelson 
McWilliams Center for Cosmology
Department of Physics
Carnegie Mellon University
15213PittsburghPAUSA

Modeling baryonic physics in future weak lensing surveys

MNRAS
0002018Accepted XXX. Received YYY; in original form ZZZPreprint 6 September 2018 Compiled using MNRAS L A T E X style file v3.0cosmological parameters -cosmology : theory -large-scale structure of Universe
Modifications of the matter power spectrum due to baryonic physics are one of the major theoretical uncertainties in cosmological weak lensing measurements. Developing robust mitigation schemes for this source of systematic uncertainty increases the robustness of cosmological constraints, and may increase their precision if they enable the use of information from smaller scales. Here we explore the performance of two mitigation schemes for baryonic effects in weak lensing cosmic shear: the PCA method and the halo-model approach in HMcode. We construct mock tomographic shear power spectra from four hydrodynamical simulations, and run simulated likelihood analyses with CosmoLike assuming LSST-like survey statistics. With an angular scale cut of max < 2000, both methods successfully remove the biases in cosmological parameters due to the various baryonic physics scenarios, with the PCA method causing less degradation in the parameter constraints than HMcode. For a more aggressive max =5000, the PCA method performs well for all but one baryonic physics scenario, requiring additional training simulations to account for the extreme baryonic physics scenario of Illustris; HMcode exhibits tensions in the 2D posterior distributions of cosmological parameters due to lack of freedom in describing the power spectrum for k > 10 h −1 Mpc. We investigate variants of the PCA method and improve the bias mitigation through PCA by accounting for the noise properties in the data via Cholesky decomposition of the covariance matrix. Our improved PCA method allows us to retain more statistical constraining power while effectively mitigating baryonic uncertainties even for a broad range of baryonic physics scenarios.

# INTRODUCTION

The origin of the accelerated expansion of the Universe has been one of the most profound mysteries in modern cosmology since its discovery (Riess et al. 1998;Perlmutter et al. 1999). The ΛCDM framework is currently consistent with observations of the expansion history of our Universe from early (Planck Collaboration et al. 2016) to late times (DES Collaboration et al. 2017). Ongoing photometry surveys such as KiDS (Kilo-Degree Survey 1 ), HSC (Hyper Suprime-Cam 2 ) and DES (Dark Energy Survey 3 ) or future experiments such as LSST (Large Synoptic Survey Tele-model for matter density power spectrum, P δ (k, z), is required. It has been estimated that P δ (k, z) must be predicted to approximately 1% accuracy for k ≤ k max ∼ 10 h −1 Mpc in order to avoid biasing cosmological parameter constraints in the era of LSST (Huterer & Takada 2005;Eifler 2011;Hearin et al. 2012).

In the linear and quasi-linear regime, perturbation theory can be used to calculate the matter power spectra for a set of given cosmological parameters (Bernardeau et al. 2002). On smaller scales, N-body simulations are needed in order to capture the complicated non-linear evolution of structure growth. For example, the Halofit method employs a functional form of P δ (k, z) derived from halo models, and calibrates the model parameters from N-body simulations at various cosmological parameters (Smith et al. 2003;Takahashi et al. 2012). Alternatively, the Cosmic emu package emulates P δ (k, z) by directly interpolating the N-body simulation results at a range of cosmological models (Heitmann et al. 2010(Heitmann et al. , 2014Lawrence et al. 2017). However, only gravitational physics is included in these dark-matter-only (DMO) simulations, which neglects any modification of the matter distribution due to baryonic physics processes such as star formation, radiative cooling and feedback (e.g. Cui et al. 2014;Velliscig et al. 2014;Mummery et al. 2017). These processes can modify P δ (k, z) by tens of per cent compared to the DMO power spectra from k ≈ 1 to 10 h −1 Mpc at z = 0 (van .

There are several approaches to mitigating the impact of uncertainty in how the baryonic physics modifies the matter power spectrum. The first approach is to eliminate data points that may be affected by this uncertainty, so that limitations in small-scale modeling do not bias the inferred cosmology (e.g., see Krause et al. 2017 for the determination of the scale cuts for the DES-Y1 analysis). This approach results in a loss of cosmological constraining power, especially when the statistical precision of the data increases in the future, resulting in the need for even more conservative scale cuts. Another way of discarding data is through peak clipping (Simpson et al. 2011(Simpson et al. , 2013. By cutting the most extreme peaks in the density fields of both observed and mock data sets, the derived summary statistics become less sensitive to the poorly-modeled non-linear regime, while still allowing the use of a wider range of scales to extract cosmological information (Giblin et al. 2018). Eifler et al. (2015) propose the principal component analysis (PCA) framework, which utilizes suites of hydrodynamical simulations to build a set of principal components (PCs) describing the modification of the observables by baryonic physics. The first few PC modes point toward directions in observable space where deviation from DMO power spectra due to baryons are most dominant. One can then efficiently remove the vast majority of baryonic uncertainties by discarding the first 3 ∼ 4 PC modes. Mohammed & Gnedin (2017) point out that the training hydro simulations used to construct PCs have to be sufficiently broad in order to offer flexible degrees of freedom to span the possible baryonic scenarios for our Universe.

Other methods focus on modeling the ratio of power spectra that includes baryons to those that do not, with the goal of finding functional forms to describe the range of possible behavior of P δ,bary (k, z)/P δ,DMO (k, z). Harnois-Déraps et al. (2015) use a parametric form with 15 parameters that is able to describe the power spectrum ratio of sev-eral OWLS simulations  to within 10% precision up to k ≈ 20 h −1 Mpc and z < 1.5. Chisari et al. (2018) show that the above parametric form is sufficiently flexible to fit the power spectra ratio in the Horizon-AGN (Dubois et al. 2014) simulation to within 3% across z 4 up to k ≈ 30 h −1 Mpc, but with the downside of involving too many free parameters. The authors propose a more compact model with 4 parameters that is capable of providing a fit to Horizon-AGN to within < 5%.

Based on the fact that baryonic physics mainly affects the matter power spectrum by altering the structure of dark matter halos, another proposed approach is to model the deviations in the matter power spectrum through the framework of the halo model (Peacock & Smith 2000;Seljak 2000;Cooray & Sheth 2002). Zentner et al. (2008Zentner et al. ( , 2013 demonstrate that incorporating the halo concentration-mass relation and its redshift evolution into the halo model framework and marginalizing over the associated free parameters can successfully mitigate baryonic bias for Stage III surveys such as DES, but is insufficient for Stage IV experiments. In addition to the degree of freedom that governs halo concentration, Mead et al. (2015Mead et al. ( , 2016 consider a parameter that characterizes the mass dependence of feedback, with publicly available software available for this model in HMcode 7 . Copeland et al. (2017) further extend HMcode, introducing a core radius parameter to characterize the inner halo structure that is believed to be an outcome of baryonic effects (Martizzi et al. 2012). There are also approaches that go beyond NFW (Navarro-Frenk-White, Navarro et al. 1996) halo profiles, focusing on modeling the radial density distributions of stellar, gas, and DM components of halos to capture the main features of baryonic feedback (Semboloni et al. 2011Mohammed et al. 2014). The improvement of the halo model approach is an active research area, in particular on constraining the prior range. These halo model approaches potentially enable us to jointly constrain halo structural information and cosmological parameters from data.

Baryonic effects can be mitigated also via a joint analysis through optimized combination of different cosmological probes, as demonstrated in Osato et al. (2015). Finally, a gradient-based method is proposed recently by Dai et al. (2018). Dark matter particles in N-body simulations are moved along the gradient of estimated thermal pressure to mimic the effect of baryonic feedback. This method can be implemented as a post-processing step on N-body simulations to produce fast hydrodynamical-like simulations.

In this paper, we focus on studying two of the above baryonic mitigation methods -the PCA method and HMcode. We test the effectiveness of these baryonic physics mitigation techniques on a broad range of possible baryonic scenarios by applying them to LSST-like mock observables constructed from hydrodynamical simulations of MassiveBlack-II , Illustris (Vogelsberger et al. 2014), Eagle (Schaye et al. 2015), and Horizon-AGN (Dubois et al. 2014), and comparing their cosmological parameter constraints. In addition, for the PCA method, we investigate different ways of constructing the PCs, and provide a modification to the original formalism to improve their efficiency. This paper is organized as follows. In §2, we give an overview on the hydrodynamical simulations used in this work for the construction of our training and test sets. §3 describes the setup of our simulated LSST-like likelihood simulations . In §4, we provide the detailed theoretical formalism for the baryonic mitigation techniques from literatures and our improved PCA scheme applied in this work. §5 presents the main results of the likelihood simulations under various baryonic scenarios and compares the performances of different mitigation methods. We summarize our findings in §6, and discuss the prospects of PCA-based methods for future investigation.


# BARYONIC EFFECTS IN SIMULATIONS

In this section, we introduce the hydrodynamical simulations involved in our analysis (summarized in Table 1), and compare the impact of the baryonic physics considered on the matter distributions.


## OWLS Simulation Suite

The OWLS simulations are a large suite of cosmological hydrodynamical simulations with varying implementations of subgrid physics to enable investigations of the effects of altering or adding a single physical process on the total matter distribution (Schaye et al. 2010). Here we adopt 9 different baryonic simulations from OWLS. We refer readers to van  for a more detailed description.

• REF: The baseline simulation that contains many of the physical processes known to be important. REF includes prescriptions of radiative cooling and heating for 11 different elements, star formation assuming the Chabrier (2003) stellar initial mass function (IMF), stellar evolution, mass loss, chemical enrichment, and SN feedback in kinetic form (wind mass loading factor η = 2 and initial wind velocity v w = 600 km s −1 ; all together ηv 2 w determines the energy injected into the winds per unit stellar mass). The other 8 hydro simulations are based on REF, with modifications indicated below.

• NOSN: Exclude SN feedback.

• NOZCOOL: Exclude metal-line cooling. Only assume primordial abundances when computing cooling rates.

• NOSN NOZCOOL: Exclude both SN feedback and metal-line cooling.

• WML1V848: Adopt the same SN feedback energy per unit stellar mass as for REF, but reduce the mass loading factor by a factor of 2 (η = 1) and increase the wind velocity by a factor of √ 2 (v w = 848 km s −1 ). • WDENS: Adopt the same SN feedback energy per unit stellar mass as that of REF, but let η and v w depend on gas density (v w ∝ n 1/6 H ; η ∝ n −1/3 H ).

• WML4: Double SN feedback per unit stellar mass by increasing the mass loading factor by a factor of 2 (η = 4).

• DBLIMFV1618: Once the gas reaches a certain pressure threshold, 10% of the star formation activity follows a topheavy IMF. In this case, more high-mass stars are produced, which leads to higher SN energy feedback.

• AGN: In addition to physics included in the REF model, add a subgrid model for BH evolution and AGN feedback following the prescription of Booth & Schaye (2009). BHs inject 1.5% of the rest mass energy of the accreted gas into the surrounding matter in the form of heat.

The simulation cube for OWLS is L = 100 h −1 Mpc in comoving scale on a side. The OWLS-DMO simulation contains 512 3 collisionless DM particles; the 9 hydro simulations contain an additional 512 3 particles in the form of collisional gas or collisionless stars to capture the baryonic processes. The DM and (initial) gas particle masses are ≈ 4.06 × 10 8 h −1 M and 8.66 × 10 7 h −1 M , respectively. The gravitational softening length is ≈ 0.78 h −1 kpc in comoving scale, and is limited to a maximum physical scale of 2 h −1 kpc. The cosmological parameters used in the simulation are based on WMAP3 results (Spergel et al. 2007): {Ω m , Ω b , Ω Λ , σ 8 , n s , h} = {0.238, 0.0418, 0.762, 0.74, 0.951, 0.73}.


## MassiveBlack-II Simulation

The MassiveBlack-II (hereafter MB2) simulation is a highresolution ΛCDM cosmological simulation starting at z = 159 and evolved to z = 0 . Both DMO (Tenneti et al. 2015) and hydrodynamical MB2 simulations are conducted in a cubic simulation box with sides of length L = 100 h −1 Mpc in comoving scale. There are 1972 3 DM particles in both the MB2-hydro and MB2-DMO simulations, with an additional 1972 3 initial number of gas particles in the hydro run. The mass of each DM particle is 1.1 × 10 7 h −1 M and the initial baryonic mass resolution is 2.2 × 10 6 h −1 M . The gravitational softening length is = 1.85 h −1 kpc in comoving units. The cosmological parameters in MB2 are consistent with WMAP7 results (Komatsu et al. 2011 {0.275, 0.046, 0.725, 0.816, 0.968, 0.701}. The subgrid models of baryonic physics in MB2 includes a multiphase interstellar medium model with star formation and associated feedback by SN and stellar winds (Springel & Hernquist 2003); BH accretion, merger, and associated AGN feedback in quasar-mode Springel et al. 2005).
): {Ω m , Ω b , Ω Λ , σ 8 , n s , h} =

## Illustris Simulation

The Illustris simulation (Vogelsberger et al. 2014) is carried out in a cubic periodic box with sides of length L = 75 h −1 Mpc (comoving). We download the highest resolution snapshot data from the public release website (Nelson et al. 2015) to calculate power spectra for both hydrodynamical and DMO runs. There are 1820 3 DM particles in both hydrodynamical and DMO simulations, and an approximately equal number of baryonic particles in the hydrodynamical run. The mass of each DM particle is 4.41 × 10 6 h −1 M and the initial baryonic mass resolution is 8.87 × 10 5 h −1 M . The gravitational softening length is = 1.4 h −1 kpc in comoving units. The cosmological parameters adopted in Illustris are consistent with WMAP7 results (Komatsu et al. 2011 physics (Vogelsberger et al. 2013): gas cooling in primordial and metal-lines; stellar evolution associated with chemical enrichment and stellar mass-loss; kinetic stellar feedback driven by SN; BH accretion, merging, and related AGN feedback in terms of quasar-and radio-modes as well as associated radiative electromagnetic feedback.


## Eagle Simulation

The Eagle simulation is currently in best agreement with the observed galaxy stellar mass function among all hydrodynamical simulations considered here (Schaye et al. 2015). It is conducted in a cubic periodic box of side length L = 67. The subgrid physics used in Eagle is based on OWLS. The physical models include radiative cooling and photoionization heating; star formation associated with stellar mass loss and energy feedback; BH mergers, gas accretion, and AGN feedback. The most important changes compared to OWLS are: star forming feedback energy changing in terms of thermal form rather than kinetic; accounting for angular momentum during the accretion of gas onto BHs; inclusion of a metallicity-dependence in the star formation law. In contrast to many hydrodynamical simulations, Eagle employs stellar and AGN feedback only in thermal form, which captures the collective effects of mechanisms such as stellar winds, radiation pressure, SN feedback, radio-and quasarmode AGN feedback. One major improvement in the treatment of thermal feedback is that it can be performed without turning off radiative cooling and hydrodynamical forces.


## Horizon-AGN Simulation

The Horizon-AGN (Dubois et al. 2014) is carried out in a cubic periodic box of side length L = 100 h −1 Mpc (comoving). There are 1024 3 DM particles in both the DMO and hydrodynamical runs, with the DM particle mass of 9.9 × 10 7 h −1 M for the DMO run, and 8.3 × 10 7 h −1 M for the hydrodynamical run. The initial gas particle mass is about 1 × 10 7 h −1 M . The cosmological parameters used in the simulation are compatible with WMAP7 cosmology (Komatsu et al. 2011 .272, 0.045, 0.728, 0.81, 0.967, 0.704}. Subgrid physics models for a variety of baryonic physics effects are implemented in Horizon-AGN. Gas is allowed to cool down to 10 4 K via transition lines of hydrogen and helium as well as metals using the Sutherland & Dopita 1993 model. When the hydrogen number density exceeds a threshold of 0.1 H cm −3 , star formation is triggered following a random Poisson process (Rasera & Teyssier 2006;Shandarin & Zeldovich 1989). SN feedback is taken into account assuming an IMF with a low-mass cut-off at 0.1 M and a high-mass cut-off at 100 M . Chemical enrichment happens along with SN explosions and stellar winds. The AGN feedback is modeled in a combination of two different modes: the kinematic radio mode when M BH / M Edd < 0.01 and the thermal quasar mode otherwise.
): {Ω m , Ω b , Ω Λ , σ 8 , n s , h} = {0

## Comparison of Power Spectra in Hydrodynamical versus DMO Simulations

From the snapshot data release of Eagle, MB2 and Illustris, we calculate the matter power spectra as detailed in Appendix A. For OWLS and Horizon-AGN simulations, we use the computed results from van Daalen et al. (2011) and Chisari et al. (2018), respectively. Power spectra from DMO simulations, with the same initial condition as their paired hydrodynamical simulations, are also computed in order to perform a fair comparison across simulations with different cosmological parameters and with reduced cosmic variance. Figure 1 shows the z = 0 ratio of power spectra from different hydrodynamical simulations with respect to their counterpart DMO simulations. The thin lines indicate the nine different baryonic scenarios in the OWLS simulation suite. For the eight baryonic scenarios without AGN feedback, the common feature is a rapid increase in power on small scales. The power enhancement is due to efficient cooling of gas which eventually leads to formation of galaxies within halos, and further concentrates the DM distribution (Blumenthal et al. 1986 ing power spectra show significant differences. The feedback mechanism in Illustris drastically suppresses the power by 35% at k ≈ 5 h −1 Mpc. Eagle reaches its maximum suppression of power of 20% at k ≈ 20 h −1 Mpc. A similar trend is also observed in Horizon-AGN, but it reaches its minimum amplitude reduction of 10% at k ≈ 10 h −1 Mpc. Going towards higher k, we start to see that the ratio curves bend upward and keep increasing beyond k of 30 h −1 Mpc. The MB2 power spectrum behaves relatively similar to DMO, but still the baryonic prescription prevents the power spectrum ratio from growing too quickly compared to the OWLS scenarios without AGN feedback, which suffer from severe overcooling effect.

The input cosmologies (p co,sim ) for the five simulation suits are different. In order to predict matter power spectra with baryonic effects for arbitrary cosmological parameters, we take the power spectrum ratios shown Fig. 1 and apply the following equation:
P hydro δ (k, z | p co ) = P hydro,sim δ (k, z | p co,sim ) P DMO,sim δ (k, z | p co,sim ) P theory δ (k, z | p co ) ,(1)
where P hydro,sim δ (k, z | p co,sim ) denotes the hydrodynamical run from a given simulation; P DMO,sim δ (k, z | p co,sim ) is the corresponding DMO run; P theory δ (k, z | p co ) is the theoretical power spectrum calculated from Halofit (Takahashi et al. 2012) or HMcode (Mead et al. 2015), which are calibrated by DMO simulations.

Eq. (1) illustrates an important assumption in this work: we assume that baryonic effects on the power spectrum can be represented as a fractional change in the power spectrum, and that this fractional change is independent of cosmology. The cosmology enters our analysis only through the theoretical power spectrum P theory δ (k, z | p co ). In reality, the baryonic and cosmological effects may couple in a complex way affecting the growth of cosmic structure.


# LIKELIHOOD ANALYSIS METHODOLOGY

Here we present our methodology in estimating the cosmological constraining power for an LSST-like survey. We start by describing the theoretical models used in the work, our mock observations, the covariance matrix constructed for an LSST-like survey, and finally the likelihood formalism used in estimating the posterior distribution of cosmological parameters. The cosmological model considered in our likelihood simulation is flat wCDM, with varying cosmological parameters p co = {Ω m , σ 8 , Ω b , n s , w 0 , w a , h}.


## Theoretical Models

We rely on two main theoretical models to fit our mock observables in this work. The first one is the Takahashi et al. (2012) version of Halofit. It adopts empiricallymotivated functional forms to characterize the variation of power spectra with cosmology. Having been calibrated with high-resolution N-body simulations, it provides an accurate prediction of the nonlinear matter spectrum with 5% precision at k ≤ 1 h −1 Mpc and 10% at 1 ≤ k ≤ 30 h −1 Mpc within the redshift range of 0 ≤ z ≤ 10.

The second fitting routine is HMcode, constructed by M15. It utilizes the halo-model formalism to describe the cosmological change of power spectra via physically motivated parameters. HMcode has prescriptions for capturing the impact of baryons on the matter power spectrum via two free parameters: the amplitude of the concentration-mass relation (A; see Eq. (14) in M15), and a halo bloating parameter (η 0 ; see Eqs. (26), (29) in M15) controlling the change of dark matter halo profiles in a halo mass-dependent way to account for different feedback energy levels. When allowing A and η 0 to vary, it can successfully fit the power spectra from various baryonic scenarios of OWLS (M15). When fixing A = 3.13 and η 0 = 0.6044, HMcode functions as a regular DMO-based emulator, which is calibrated with high-resolution N-body simulations to an accuracy of ≈ 5% at k ≤ 10 h −1 Mpc for z ≤ 2. We note that the ≈ 5% discrepancy between the DMO mode of HMcode and Halofit is non-negligible within LSST statistics. We therefore construct two sets of mock observables based on each theoretical model.


## Mock Observational Data

We rely on four hydrodynamical simulations: Eagle, MB2, Illustris and Horizon-AGN to study the bias in cosmological parameters when analyzing weak lensing data while ignoring baryonic effects. Assuming that we were living in these ] 1 tomo bin, true redshift distribution 10 tomo bins, Gaussian photo-z Figure 2. The normalized galaxy number density split into ten Gaussian tomographic photo-z bins as shaded regions from blue (low z) to green (high z). For comparison, we show the true underlying redshift distribution as a solid blue line.

baryonic universes, we construct mock observables from the snapshot data of these hydro simulations, and investigate the performances of the PCA method (Eifler et al. 2015, hereafter E15) and the halo model approach (Mead et al. 2015, hereafter M15) on mitigating baryonic effects. These methods will be described in more detail in §4.

We consider tomographic weak lensing shear power spectra as the summary statistics. These are defined as:
C i j ( ) = 9H 4 0 Ω 2 m 4c 4 ∫ χ h 0 d χ g i ( χ)g j ( χ) a 2 ( χ) P δ f K ( χ) , χ .(2)
Here C i j (l) is the convergence power spectrum for tomographic bin combination {i, j} at angular wavenumber l, χ is the comoving distance, χ h is the comoving horizon distance, f K ( χ) is the comoving angular diameter distance (set to χ since we assume a flat Universe), a( χ) is the scale factor, and P δ is the 3D matter power spectra. The lens efficiency in the i-th tomographic interval is defined as
g i ( χ) = ∫ χ h χ d χ n i ( χ ) f K ( χ − χ) f K ( χ )(3)
with n i ( χ (z)) being the redshift distribution of source galaxies in tomography bin i. The overall source redshift distribution is parametrized in the form of
n(z) ∝ z α exp − z z 0 β ,(4)
where α = 1.27, β = 1.02, and z 0 = 0.5 following Table 2 in Chang et al. (2013), which mimics an LSST cosmic shear source galaxy sample after deblending. The number density of source galaxies is 26/arcmin 2 . We perform a tomographic analysis by dividing the sources into 10 tomographic bins with equal total number of galaxies in each bin. We also smooth the redshift distribution with a Gaussian kernel to characterize potential photo-z uncertainties. Fig. 2 shows the exact redshift distribution in each bin. This results in 55 unique combinations of Table 2. Fiducial cosmology, minimum and maximum of the flat prior on the cosmological parameters, and halo-structural parameters in HMcode. auto-and cross-correlation shear tomographic power spectra. For each of the tomographic power spectra, we consider 18 equally spaced logarithmic bins in angular wavenumber ranging from 23 ∼ 2060. This results in a total of 55×18 = 990 data points in our data vector. For the main analysis of this paper, we adopt an upper limit of max ≈ 2000. This limit is driven by the resolution of the hydrodynamical simulations used in this work. We refer readers to Appendix B for further details on how we extrapolate power spectra to perform the integration to derive C i j ( ), and how the decision on the max ≈ 2000 cut is made. The fiducial cosmology p co,fid of the data vectors is set to be consistent with the Planck 2015 (TT+TE+EE+lowP and assuming ΛCDM) results (Planck Collaboration et al. 2016) as summarized in Table 2.


## Parameter Fiducial Prior

Our mock data vectors for various baryonic physics scenarios are computed with the P δ term in Eq. (2) generated from Eq. (1). Since Halofit and HMcode (in DMO mode) agree at the level of 5% to k = 10 h −1 Mpc, and 10% out to k ≤ 100 h −1 Mpc (see Fig. 4 of M15), we create two sets of Eagle/MB2/Illustris/Horizon-AGN data vectors, with P theory δ (k, z | p co,fid ) generated from Halofit or HMcode, and incorporate the baryonic features through the power spectrum ratio. Throughout our experiment, when relying on Halofit or HMcode as the theoretical model to perform fitting, we use the same fitting function to generate the mock observational data vectors for the fiducial cosmology. This way, when comparing the performance of different baryonic mitigation schemes, if one of the methods fails to recover the fiducial cosmological parameters, we can be assured that this failure is purely because of that method's inability to mitigate the modification of the matter power spectrum due to baryonic physics, not because of an inherent discrepancy between the mock data and the DMO matter power spectrum model.

In Fig. 3 we show the ratio of baryonic to DMO C 00 ( , p co,fid ) shear power spectrum for various simulations. The thin lines indicate the nine baryonic scenarios from the OWLS simulation suite. The thick lines represent the Eagle/MB2/Illustris/Horizon-AGN universes, which are the data vectors that we will use for the LSST-like experiment. One can see that in this lowest tomographic bin, even for large scales at ≈ 100, the baryonic scenario of Illustris already causes a deviation from DMO at the 5% level, with even more severe suppressions at smaller angular scales. For higher redshift tomographic bins, the deviations between hy-  drodynamical and DMO simulations are less severe. Semboloni et al. (2011) showed that a scale cut of max ≈ 500 would be needed to avoid w 0 bias for a Euclid-like survey if the baryonic scenario of our Universe is like OWLS-AGN. When applying the traditional way of mitigating baryonic uncertainty by omitting small scale information, we would need to discard a considerable amount of data before we can rely on DMO-based theoretical model to achieve an unbiased cosmological inference. One subtle feature shown in Fig. 3 is that there is a small but noticeable large-scale excess of power (< 0.4%) in the Horizon-AGN simulation. This is because the power spectrum ratio between hydrodynamical and DMO runs of Horizon-AGN has < 0.1% excess at large scales (see Fig. 1), even though they share the same initial conditions. The true cause of this subtle excess is not clear. After exploring, Chisari et al. (2018) concluded that this may originate from the box being too small to reach the linear regime at large scales. However, the other simulations studied here are similar in size and do not exhibit this feature.


## Covariance Matrix

We generate the analytical covariance matrix of tomographic shear power spectra using CosmoLike (Eifler et al. 2014;Krause & Eifler 2017). Briefly, our covariance matrix contains both Gaussian and non-Gaussian parts. The Gaussian covariance matrix contains contributions from cosmic variance and shape noise, derived under the assumption that the 4pt-function of the shear field can be expressed in terms of 2pt-functions ( The non-Gaussian part is given by the convergence trispectrum derived using the halo model (Cooray & Sheth 2002), which contains one-, two-, three-, and four-halo terms and a halo sample variance term characterizing the scatter of halo number density due to large-scale density fluctuations (Cooray & Hu 2001;Takada & Jain 2009;Sato et al. 2009). The exact equations of our implementation can be found in the appendix of Krause & Eifler (2017).

We assume 18,000 deg 2 as the survey area in our covariance matrix and adopt the same redshift distribution and source galaxy number density (26/arcmin 2 ) as depicted in Fig. 2. The shape noise is set to be σ = 0.26 in each ellipticity component.


## Likelihood Formalism

Given a data vector D (at some fiducial cosmology and with baryonic effects from Eagle/MB2/Illustris/Horizon-AGN), one can infer the corresponding posterior probability distribution of cosmological parameters p co and potential nuisance parameters p nu via Bayes' theorem:
P( p co , p nu |D) ∝ L(D| p co , p nu )P r (p co , p nu ) ,(5)
where P r ( p co , p nu ) denotes the prior probability distribution and L(D| p co , p nu ) is the likelihood. In this work, we assume a Gaussian likelihood function for the observables,
L(D| p co , p nu ) ∝ exp − 1 2 (D − M) t C −1 (D − M) χ 2 (p co , p nu ) .(6)
We further assume that the covariance C is constant in parameter space for simplicity (but see Eifler et al. 2009; Morrison & Schneider 2013 for likelihood analysis with cosmologydependent covariance matrix). As described in §3.1, the model vector M may be derived based on Halofit which is a pure function of cosmology M = M(p co ), or it can be a function of some nuisance parameters M = M(p co , p nu ) as well, with factors that are known to affect D absorbed in p nu . For example, in HMcode, we have A and η 0 acting as nuisance parameters to account for the baryonic effects (see §3.1 for details). The final posterior distribution on cosmological parameters then can be derived by marginalizing over all other nuisance parameters in the model
P( p co |D) ∝ ∫ d p nu P( p co , p nu |D) .(7)
We use the python emcee package (Foreman-Mackey et al. 2013), which relies on the algorithm of Goodman et al. (2010) to sample the parameter space spanned by p co ({Ω m , σ 8 , Ω b , n s , w 0 , w a , h 0 }) as well as p nu (if needed depending on the model). Altogether, we have conducted ∼250 likelihood simulations to present the results for this paper. The MCMC (Markov Chain Monte Carlo) chains contain ∼ 200000 to 400000 MCMC steps (after discarding 100000 steps as burn-in phase), depending on the dimension of the parameter space which ranges from 7∼16. For simplicity, we assume flat priors for all of our parameters, with their minimum and maximum values summarized in Table 2. For likelihood simulations with informative priors based on Planck, we refer readers to E15. Informative priors help to better constrain n s , Ω b , and h, to which cosmic shear is not very sensitive. In all cases, baryonic physics was ignored during the likelihood analysis, hence providing a worst-case scenario for biases due to baryonic physics. The analyses are carried out assuming noninformative priors on the parameters. Here, and in all such 2D posterior plots below, the contours depict the 68% confidence levels. Depending on the intensity of the baryonic feedback, the resulting posterior distributions can be significantly away from the fiducial cosmology (marked in gray lines).

We will present in §4 on how we implement various baryonic mitigation schemes in the likelihood analysis. But before that, in Fig. 4 we show the posterior distribution of cosmological parameters derived from our LSST likelihood simulation, when naively applying the Halofit model on fitting the data vectors contaminated with baryonic effects from Eagle/MB2/Horizon-AGN/Illustris simulations. For ease of visualization, we only show posteriors in the subspace of four cosmological parameters out of seven in total. Depending on the intensity of baryonic feedback as reflected in the ratio of hydrodynamical to DMO power spectra shown in Fig. 1, the resulting cosmology constraints can be severely biased in the case of Illustris (2σ ∼ 13σ depending on cosmological parameters) or at 1σ ∼ 2σ level in the other three cases. We note that the degree of bias depends on the max used in the analysis. Fig. 4 presents the result when applying a cut at max ≈ 2000 on D, which is the default setting in the paper. In §5.4, we will show how this result changes when extending data vectors to max ≈ 5000.


# METHODS OF MITIGATING BARYONIC EFFECTS

In this section, we describe the methods used to mitigate the impact of baryonic physics on the cosmological parameter estimates from weak lensing. The methods can be classified into two categories: PCA-based methods and the halo-model based approach. We discuss several PCAbased methods that are minor variants of each other in §4.1 to §4.3. The halo-model based approach is described in §4.4. Throughout the work, we use the nine OWLS simulations as our 'training sample' to construct PCs for the PCA-based methods, and use the four mock data vectors constructed from Eagle/MB2/Illustris/Horizon-AGN simulations as 'test sample' to test methods listed in Table 3.


## PCA in Difference Matrix


### Summary of the original PCA framework

The original framework for using PCA to mitigate the impact of baryonic physics for weak lensing is described in Eifler et al. (2015). The essential idea is that even though hydrodynamical simulations with different baryonic prescriptions predict a range of variations on the matter power spectra ( Fig. 1), we can still extract the common features of those diversity using PCA, and build an empirical model to mitigate baryonic uncertainty based on these hydrodynamical simulations. Below we provide a step-by-step description of the PCA framework. We collect the tomographic shear power spectra constructed from the nine OWLS simulations as our training sample, and label these nine data vectors as B 1 , ..., B 9 . Next we build a difference matrix ∆( p co ) with dimension of N data ×N sim = 990×9. Each column records the deviation between the baryonic data vector and the DMO model vector M at any arbitrary cosmology (recomputed for each MCMC step) in terms of their difference
∆(p co ) =       B 1 − M B 2 − M . . . B 9 − M       N data ×N sim .(8)
Both B x (p co ) and M( p co ) are functions of cosmology, and therefore so is ∆. To produce a baryon-contaminated vector B x at cosmology p co , in principle we should rely on Eq. (1) to generate the matter power spectrum for that cosmology, and integrate it to derive the tomographic shear data vector
C i j hydro, x ( | p co ) = 9H 4 0 Ω 2 m 4c 4 ∫ χ h 0 d χ g i ( χ)g j ( χ) a 2 ( χ) P hydro, x δ f K ( χ) , χ| p co .(9)
However, to increase the computational speed, we approximate this step by Table 3. Summary of baryonic physics mitigation techniques. The first column is the label of each method, which we refer to in the text and plots throughout the work. The second column has simple descriptions that highlight the essential elements of each method. The third column presents the exact χ 2 equations that go into the likelihood analysis. Finally, the last column provides a section number where more information can be found for each method.  Figure 5. The ratio of tomography power spectra ratio at bin C 00 between hydrodynamical and DMO simulations evaluated at
B x (p co ) = C i j hydro,x ( p co ) = C i j hydro, x (p co,fid ) C i j theory ( p co,fid ) C i j theory (p co ) ,(10)

## Method Brief description
χ 2 equation Section reference A PCA in difference matrix, with exclusion [(D − M) pc,cut ] t C −1 pc,cut [(D − M) pc,cut ] §4.1.1 & §4.1.2 B PCA in difference matrix, with marginalization [D − M D (p co , Q)] t C −1 [D − M D (p co , Q)] §4.1.3 C PCA in L −1 weighted difference matrix, with exclusion [U ch PU t ch L −1 (D − M)] t I [U ch PU t ch L −1 (D − M)] §4.2 D PCA in fractional difference matrix, with marginalization [D − M R (p co , W )] t C −1 [D − M R (p co , W )] §4.3 M Halo model parameter marginalization [D − M HMcode (p co , A, η 0 )] t C −1 [D − M HMcode (p co , A, η 0 )]§4.Ratio(p co )/C 00 Ratio(p co,fid ) owls-AGN p co,fid Ω m = 0.35 Ω m = 0.25 σ 8 = 0.85 σ 8 = 0.75various p co v.s. p co,fid , i.e, [ C 00 hydro (pco) C 00 DMO (pco) ]/[ C 00 hydro (p co,fid ) C 00 DMO (p co,fid )
]. Here different curves indicate changes of Ω m or σ 8 to values shown in the legend, while keeping the remaining cosmological parameters the same as p co,fid . The fact that all ratio curves are ≈ 1 to within 0.25% indicates the validity of using Eq. (10) as our approximation.

where C i j hydro, x (p co,fid ) is pre-computed using Eq. (9) setting at p co,fid and stored. C i j theory (p co ) is our model vector M(p co ) generated from Halofit. Approximating Eq. (9) by Eq. (10) avoids the need to integrate nine times when constructing the nine columns of ∆(p co ) at each MCMC step. In using Eq. (10), we basically assume the quantity
[ C 00 hydro (p co ) C 00 DMO (p co ) ]/[ C 00 hydro (p co,fid ) C 00 DMO (p co,fid )
] ≈ 1 at various p co . To check the validity, we compute all the elements in this quantity using Eq. (9) and plot it in Fig. 5, with p co set at different values of Ω m or σ 8 , while keeping the rest of the cosmological parameters the same as p co,fid . As shown, the C 00 ratio curves are within 0.25% of 1 for various p co demonstrated here. The second step is to perform the PCA analysis on the difference matrix, with the goal of identifying the few dominant principle components (PCs) that signify the directions of largest discrepancy between the baryonic and DMO data vectors from the nine OWLS simulations. To find the PCs, we apply the (full) singular value decomposition (SVD) on ∆,
∆ = U Σ V t .(11)
We use Fig. 6 to illustrate the idea of SVD. SVD decomposes ∆ into the product of three matrices. Both U and V are square unitary matrices with dimensions of N data × N data (990 × 990) and N sim × N sim (9 × 9) respectively. The upper N sim × N sim (9 × 9) block of Σ is a diagonal matrix consisting of N sim (9) positive real singular values σ 1 ...σ 9 arranged in descending order, and the remaining N data − N sim (981) rows have only zeros (indicated by the dashed square). The N data (990) columns of U are eigenvectors of ∆∆ t , with eigenvalues in the diagonal entries of ΣΣ t . The first 9 eigenvectors constitute a set of orthogonal PCs in orders of decreasing importance according to the amount of variation they capture in the different training vectors. They span a 9-dimensional subspace within the 990 dimensional space which covers entirely the degrees of freedom to explain baryonic uncertainties in the nine OWLS hydro simulations. In other words, any given B x (p co ) − M(p co ), can be described with 9 free parameters via
B x (p co ) − M( p co ) = 9 n=1 Q n PC n ( p co ) ,(12)
with Q n being the amplitude of PC n . The remaining 981 columns of U are silent orthogonal vectors which extends U into a unitary matrix. With 9 baryonic scenarios as our training sample, we have at most 9 independent PCs to describe modifications to the observables due to baryonic physics.

One of the goals of this work is to understand how effectively the PCA basis can describe baryonic physics scenarios in other more recent hydrodynamical simulations. The third step is to mitigate baryonic uncertainty between D and M by excluding N PC modes. We perform
(D − M) exN = UP N U t (D − M) .(13)
The operation U t (D − M) transforms the difference vector D − M into the PC basis
(D − M) pc = U t (D − M) .(14)
In the PC basis, the majority of the baryonic uncertainties would be absorbed in the first few elements of (D − M) pc . We then apply a projection matrix P N (= P 2 N ) on (D − M) pc to remove these highly-contaminated elements from both the Figure 6. We perform singular value decomposition (SVD) on the difference matrix ∆ built based on the 9 baryonic scenarios of OWLS (see Eq. (8)). U is a unitary matrix with columns that form an orthonormal basis set to span the 990-dimensional space of our data vector. Among them, the first 9 PCs of U form a complete description of the modifications of the data vector due to baryonic physics in the nine OWLS hydro simulations. We will test whether these 9 PCs can also describe the impact of baryonic physics in the Eagle/MB2/Illustris/Horizon-AGN simulations. data and the model.
Nsim x Nsim Ndata x Ndata = Δ U Σ V t (990 x 990) (990 x 9) (9 x 9) 9 981 σ1 σ9 σ2 • • • PC1 PC9 … Ndata x Nsim (990 x 9) Ndata x NsimHere P N =0 = 1 (identity matrix) if no
PCs are excluded, and we can remove N PCs by setting the first N diagonal elements in P N to zero. We can then transform back to the original basis by taking an inner product with U. Figure 7 shows the effectiveness of excluding PC modes via Eq. (13) with both D and M set to the same cosmology, p co,fid . We consider the lowest tomographic bin C 00 . The upper left panel shows the inconsistency between D and M in the raw data (i.e., when no PC mode is removed) for various hydrodynamical simulations. Notice that since we are not plotting the fractional difference, the discrepancies shift toward larger scale contradicting the impression that baryonic effects are dominant at small scale. The thicker lines indicate cases for Eagle/MB2/Horizon-AGN/Illustris. This amount of discrepancy leads to biased cosmological inference as was already shown in Fig. 4. The thinner lines indicate the difference vectors of OWLS. One can see that the overall largest discrepancies of OWLS are apparent around ≈ 200. Therefore, the first PC identified from ∆ should capture the impact of baryonic physics in the data vectors around that scale. After removing the first PC mode (upper right panel), it is clear that a large amount of the original discrepancy can be efficiently removed by PC 1 for the Illustris and Eagle baryonic scenarios. This is because their baryonic features in terms of difference vectors are similar to many of the OWLS baryonic scenarios (i.e., with the largest decrement at ≈ 200). More PC modes must be removed to reduce the impact of baryonic physics on the observables for Horizon-AGN and MB2. For Horizon-AGN, the main difference appears on the largest scales, which is a feature that does not exist in the OWLS simulations. This large-scale discrepancy is due to the subtle excess of power at low k, for which the origin is unclear (see the end of §3.2 for details). For the MB2 scenario, although the overall impact of baryonic physics on the observables is mild, the distinct -dependence (see also Fig. 1) differs from what is seen in the OWLS training set. As a result, more PC modes must be excluded in order to reduce the data-model discrepancy. After six PC modes are removed, all features of baryonic physics on the observables are substantially reduced across all angular scales, which makes it more likely that we can achieve an unbiased inference of cosmological parameters after applying the PCA technique.

Finally, when performing MCMC analysis, we modify the original χ 2 in Eq. (6) to
χ 2 ( p co ) = [(D − M) exN ] t C −1 [(D − M) exN ] (15a) = [UPU t (D − M)] t C −1 [UPU t (D − M)] (15b) = [(D − M) t UP][PU t C −1 UP][PU t (D − M)] ,(15c)
with (D− M) exN is defined in Eq. 13. From Eq. (15c), one can see that when P = 1, with UU t = 1, we recover the original χ 2 equation as defined in Eq. (6).


### Improvement of the PCA framework (Method A)

In this work, we modify the original PCA formalism of E15 to properly account for the change of covariance matrix due to the information loss after PC mode removal in D and M.

In Eq. (15a), after PC mode removal, the new difference vector (D − M) exN is still subjected to the same inverse covariance matrix C −1 . Doing so neglects the fact that the PC mode exclusion results in the loss of any cosmological information in these PC modes, and hence leads to an underestimation of errors on p co . To address this problem, the relevant covariance matrix elements in the PC basis must effectively be set to infinity to account for this information loss.

To do so, let us view everything in the PC basis, where our data and model vectors are defined as
D pc = U t D (16a) M pc = U t M ,(16b)
and the covariance matrix is
C pc = U t C U .(17)
Suppose we are going to remove N PC modes, after setting the first few elements of D pc and M pc to zero by applying the projection operator. In that case, we also must set the first N diagonal elements of C pc to infinity (C pc,inf N ) to account for the loss of information in the removed PC modes. Under this setting the new χ 2 equation becomes
χ 2 (p co ) = [P N (D pc − M pc )] t C −1 pc,inf N [P N (D pc − M pc )] (18a) = [(D − M) t UP N ] C −1 pc,inf N [P N U t (D − M)] . (18b)
Comparing Eqs. (18b) and (15c), the inverse covariance matrix differs between the original and the corrected methods in a way that ensures the information loss in the data vector is properly accounted for.

To avoid dealing with the infinity when computing C −1 pc,inf N , we use the following steps to derive χ 2 ( p co ). Instead of setting the first few PC modes to be zero by applying the projection matrix, we directly cut the data vector D pc to obtain a shorter vector D pc,cut , and do the same to the model vector M pc → M pc,cut . Next, we cut the corresponding rows and columns on C pc , and use the corresponding sub-matrix, C pc,cut to calculate the inverse covariance C −1 pc,cut for D pc,cut . The χ 2 equation can then be written as:
χ 2 (p co ) = (D − M) t pc,cut C −1 pc,cut (D − M) pc,cut .(19)
One can easily use an 2 × 2 covariance as an example to illustrate the equivalence of Eqs. (19) 
L(D| p co ) ∝ exp − 1 2 (D − M) t pc,cut C −1 pc,cut (D − M) pc,cut χ 2 (p co ) .(20)

### The marginalization version of the PCA framework (Method B)

We refer to 'PC marginalization' as a method that includes (up to nine) amplitudes of PCs as free parameters to parametrize the impact of baryonic physics on the tomographic shear power spectra. As shown in Eq. (12), the current 9 PCs fully span the baryonic degrees of freedom in the 9 OWLS simulations. We can further check whether they are also effective in describing the impact of baryonic physics on the observables in our test set of hydrodynamic simulations by building a new model with the following parametric form:
M D ( p co , Q) = M( p co ) + m n=1 Q n PC n (p co ) .(21)
where m 9, and Q = {Q 1 , Q 2 , ..., Q m } are free parameters in addition to the cosmological parameters. The likelihood function for the cosmological parameters can be derived by marginalizing over the amplitude parameters:
L(D| p co ) ∝ ∫ dQ × exp − 1 2 (D − M D ( p co , Q)) t C −1 (D − M D ( p co , Q)) .(22)
From an information perspective, we expect identical outcomes from PC mode removal, with the likelihood function in Eq. (20) (method A), and PC marginalization, with the likelihood function in Eq. (22) given uninformative priors of PC amplitudes (method B). We will provide comparisons of the posterior distributions of p co in §5.1 and further comment on both methods there.


## Noise-weighted PCA -Cholesky

Decomposition (Method C)

As noted at the end of §2.2 of E15, performing PCA on the difference matrix ∆ (Eq. (8)) is not necessarily the most optimal choice. They suggested an option of conducting the PCA on the 'noise'-weighted ∆. As a result of re-weighting, the derived PCs would be more sensitive in accounting for deviations in data vectors due to baryonic physics at wellmeasured data points, where larger weighting factors are applied. Therefore, when doing PC mode removal, we tend to more effectively remove baryonic physics degrees of freedom that impact better-measured (lower noise) scales, which may more effectively reduce cosmological parameter biases.

To find the weights, we first decompose our covariance matrix by applying a Cholesky Decomposition
C = LL t ,(23)
where L is a lower triangular matrix with real and positive diagonal entries. We can then weight our D and M vectors as
D ch = L −1 D , M ch = L −1 M .(24)
After this transformation, our new data vector D ch has an identity covariance matrix 1, which can be easily proved as
follows C ch = (D ch − D ch )(D ch − D ch ) t = L −1 (D − D)(L −1 (D − D)) t = L −1 (D − D)(D − D) t (L −1 ) t = L −1 C −1 (L −1 ) t = 1 .(25)
In other words, after applying Eq. (24), we not only reweight but also decorrelate the data vector. Similar to Eq. (8), we build the new difference matrix as
∆ ch (p co ) =       B 1,ch − M ch . . . B 9,ch − M ch       N data ×N sim = L −1 ∆( p co ) = U ch Σ ch V t ch .(26)
Here each of the OWLS training data vectors is weighted by
L −1 as B x,ch = L −1 B x .
The ∆ ch matrix is equivalent to performing a L −1 matrix transformation on ∆ shown in Eq. (8).

We can then apply SVD to derive the PC basis set as stored in the U ch (p co ) matrix. Similar to §4.1.2, to perform the PC mode removal, we transform everything to the PC basis:
D ch,pc = U t ch D ch (27a) M ch,pc = U t ch M ch (27b) C ch,pc = U t ch C ch U ch = 1 ,(27c)
and then cut all the elements from the data and model vectors and the covariance matrix for the PC modes that are to be removed. Here since C ch is an identity matrix, it and its inverse C −1 ch,pc in the PC basis remain the same after coordinate transformation. The final PC mode removal χ 2 equation becomes:
χ 2 ch ( p co ) = (D ch − M ch ) t pc,cut C −1 ch,pc cut (D ch − M ch ) pc,cut = (D ch − M ch ) t pc,cut (D ch − M ch ) pc,cut(28)
In Fig. 8, we show the D ch − M ch = L −1 (D − M) vectors in our lowest tomographic bin, at p co,fid . The thicker lines represent our four test simulations; the thinner lines are for the nine baryonic scenarios in OWLS, which compose the columns of ∆ ch in Eq. (26). Comparing with the upper left panel of Fig. 7, one can see that after re-weighting by L −1 , we more strongly emphasize baryonic fluctuations at smaller scales, so the PCs should also be more effective in accounting for small-scale baryonic features. 8


## PCA in Fractional Difference Matrix (Method D)

Instead of using the difference matrix ∆ to perform PCA, Mohammed & Gnedin (2017) identified PCs based on the fractional difference matrix R defined as:
R =       B 1 −M M B 2 −M M . . . B 9 −M M       990×9 = U R Σ R V t R .(29)
8 Although we plot D ch − M ch vs. in Fig. 8, we note that actually the new data points are not strictly functions of the original because of the non-zero off-diagonal terms in L −1 . However, our take-away point from Fig. 8 still holds due to the fact that our covariance matrix is dominated by Gaussian noise, and thus the off-diagonal terms in L −1 are small. One fundamental difference between the fractional difference matrix R and the difference matrices ∆ or ∆ chy is that R does not depend on cosmology, given our assumption of Eq. (10). After the U R is derived by SVD analysis, a model for the observables with baryonic physics degrees of freedom spanned by OWLS can be built as:
M R (p co , W ) = M(p co ) 1 + m n=1 W n PC n ,(30)
where m 9, and W = {W 1 , W 2 , ..., W m } are free parameters controlling the amplitudes of PCs, and PC 1 ∼ PC 9 are in the first nine columns of U R . Similar to the methodology in §4.1.3, the likelihood function for the cosmological parameters can be derived by marginalizing over the amplitude parameters:
L(D| p co ) ∝ ∫ dW × exp − 1 2 (D − M R (p co , W )) t C −1 (D − M R (p co , W )) .(31)
Similar to the concept mentioned in §4.2, performing PCs on the matrix R can be viewed as putting the weight of 1/M into the PCA analysis. Since M decreases with increasing , and the overall amplitude of M increases toward higher redshift, after taking its inverse, we upweight data points at smaller scales and lower redshift. The fractional difference vectors of OWLS that go into columns of R are plotted in Fig. 3. The PCs derived from R are expected to be more efficient in accounting for smaller scale and lower redshift variation of the observables due to baryonic physics.


## HMcode (Method M)

Finally, we compare the above PCA-based methods with the halo model-based approach proposed from Mead et al. (2015), HMcode. HMcode utilizes two halo profile-related parameters to capture the impact of baryonic physics on the matter power spectrum: the amplitude of the concentrationmass relation (A) and a halo bloating parameter (η 0 ) controlling the (mass-dependent) change of halo profiles. We refer readers back to §3.1 for a brief summary of this approach.

There exists some level of degeneracy between A and η 0 , as shown in Fig. 6 of M15. Thus, when implementing the likelihood analysis, one can either vary both of the parameters, or change only the single parameter A while fixing Equation (32) is derived based on the OWLS simulation suite. We will test whether it remains valid for the baryonic physics scenarios in Eagle/MB2/Illustris/Horizon-AGN for our forecasted scenario with LSST-like statistical power. Also, we will compare the performances of HMcode (marginalization over halo model parameters) with the above PCA-based methods.
η 0 = 0.98 − 0.12A.(32)

# PERFORMANCES OF BARYONIC MITIGATION TECHNIQUES

In this section, we present our simulated likelihood analysis for the different baryonic mitigation schemes listed in Table 3. Ideally, we need a baryonic physics mitigation strategy that can reduce the biases in cosmological parameters due to inaccuracies in theoretical modeling (as demonstrated in Fig. 4) to a level that is much smaller than the statistical uncertainties. In addition, we hope that the increase in statistical errors on cosmological parameters due to the additional nuisance parameters will be as small as possible.Throughout this section, we will use a criterion of bias < 0.5σ (where σ represents the marginalized statistical error) for individual cosmological parameters to evaluate whether a method is effective in mitigating the uncertainties due to baryonic physics under various baryonic scenarios. We also compare their performance based on the degradation of cosmological constraining power through the size of the 1D marginalized uncertainties on cosmological parameters.   Table 3. The yellow dot-dashed and black dotted contours indicate the 1σ contours of the posterior probability distributions obtained from methods A and B, respectively, for the Horizon-AGN simulation after excluding or marginalizing over the first PC modes. Similarly, the blue solid and red dashed contours indicate the case for Illustris after excluding or marginalizing over 3 PC modes. The excellent match between the posterior probability distributions for cosmological parameters between methods A and B confirms that the PC exclusion formula shown in Eq. (19) is conceptually equivalent to marginalizing over PC amplitudes.
σ 8 − 1 . 5 0 − 1 . 2 5 − 1 . 0 0 − 0 . 7 5 w 0 − 1 . 6 − 0 . 8 0 . 0 0 . 8 1 . 6 w a

## PC Mode Exclusion versus Marginalizing Over PC Amplitude

We start by comparing the methods A and B (see Ta-ble 3) with their PCs described using the same difference matrix ∆. In Method A, we modify the data vector by excluding the first few PC modes and modify the covariance self-consistently as well. In method B, the data vector and covariance matrix are unmodified, but we introduce free parameters describing the PC amplitudes to marginalize over in the likelihood analysis. Conceptually, we expect both methods to yield identical results. When removing data points (and the corresponding covariance elements), we lose all of the information that can constrain the amplitudes of the excluded PC modes. Thus, this should be equivalent to marginalizing over PC amplitudes with uninformative priors.

In Fig. 9, we use simulated likelihood analyses based on Horizon-AGN (yellow dot-dashed & black dotted) and Illustris (blue solid & red dashed) to demonstrate the excellent consistency between PC mode exclusion and PC amplitude marginalization. For the case of Illustris, large residual biases still exist after performing the baryonic physics mitigation. We will discuss this issue in §5.3. Although not shown, we have also confirmed the consistency between methods A & B for Eagle and MB2.

In conclusion, we have demonstrated with examples that the PC exclusion formula shown in Eq. (19) gives consistent results as when marginalizing over PC amplitudes with an uninformative prior. Method B can provide baryonic information through the constrained PC amplitudes, which can be used as a standard to quantify baryonic effects. So far, we allow the PC amplitudes to vary from (−∞, ∞). Reducing the prior ranges on PC amplitudes could potentially increase the constraining power on cosmology if we can develop a consistent way of setting the priors on PC amplitudes, given our knowledge of baryonic physics.

The downside of method B is that it requires running longer MCMC chains to ensure convergence due to an increase in the dimensionality of parameter space. Therefore if one does not care to learn about baryonic physics, and would simply like to marginalize over it, we recommend method A.


## Comparison between various PC construction methods

Here we compare the performances of the PCA-based methods listed Table 3. We have already shown in §5.1 that PC mode exclusion (method A) is equivalent to marginalizing over PC amplitudes (method B), so here we only compare methods A, C, and D. The fundamental difference between these PCA methods is the way the PCs are constructed from the training simulations, which affects their efficiency in describing how baryonic physics modifies the data vectors on larger or smaller scales. We refer readers back to §4 for more details about this formalism. Briefly, when PCs are derived from ∆ (method A; Eq. (8)), they are most efficient in describing the difference vector D − M. For PCs trained from ∆ chy (method C; Eq. (26)), they are most efficient in describing the noise-weighted difference, D chy − M chy = L −1 (D − M), due to baryonic physics. Finally, PCs trained from R (method D; Eq. (29)) are most efficient in describing variations in the fractional difference D−M M from baryonic effects. Figure 10 shows the median of the marginalized 1D posteriors of cosmological parameters under different baryonic physics mitigation techniques for data vectors derived from our four test simulations. The lower and upper error bars represent for the 16 and 84th quantiles of the 1D marginalized posterior distribution. The x−axes indicate numbers of PC modes excluded or numbers of marginalization parameters used in the analysis. We select some cases from Fig. 10 and present their 1D and 2D posteriors in Fig. 11. The brown crosses in Fig. 10 indicate the case when no baryonic physics mitigation scheme is applied. One can see that the deviations from the fiducial cosmological parameters exceeds 1σ for all of our test baryonic scenarios. This is also shown in Fig. 4 on the 2D posterior contours. The blue-circle, red-triangle, and yellow-square markers indicate the results of performing baryonic physics mitigation by PCA-based methods A, C, and D, respectively. When the modifications of the data vectors due to baryonic physics are relatively weak as in MB2/Eagle/Horizon-AGN, we find that removing up to 2 PC modes is sufficient to marginalize baryonic bias to within  Table 3. Each panel is for a different input data vector based on a different hydrodynamical simulation as explained in the plot title. The gray dashed horizontal lines indicate the fiducial cosmological values. The marker position, the lower and upper error bars indicate the median, the 16th and the 84th percentiles of marginalized 1D posteriors. The brown crosses indicate the results when fitting the data vectors with the DMO-based emulator (Halofit) without applying any baryonic physics mitigation technique. The blue circles, red triangles and yellow squares show the results when applying PCA-based methods A, C, and D respectively, with their positions in the x−direction indicating how many PC modes are excluded or numbers of marginalization parameters used when doing the analysis. The black pentagons located at x = 1 indicate the result when only marginalizing over A in HMcode (with η 0 fixed via Eq. (32)). The black pentagons located at x = 2 are the results when marginalizing over both A and η 0 in HMcode. For PCA-based methods, we find the 1σ posteriors start to enclose the fiducial cosmology after removing 2 PC modes for MB2/Eagle/Horizon-AGN, while excluding 6 PC modes is required for more extreme baryonic scenarios of Illustris. When using HMcode to perform marginalization, except for the Illustris simulation for which marginalizing over A alone is enough, generally it is required to vary both A and η 0 to mitigate baryonic effects to within 1σ.

1σ 9 for the cosmological parameters presented here. For the 9 The 1σ criterion is a looser condition than the 0.5σ constraint we will later use for defining acceptability; we use this looser condition here as we are just trying to compare the basic behavior of Illustris simulation, due to its strong baryonic feedback, we the different PCA methods here. Once we are comparing the bestperforming PCA methods with HMCode, we will consistently impose a 0.5σ constraint on both.  Figure 11. The 2D posterior distributions on cosmological parameters for some selected cases shown in Fig. 10. Each panel is for a different input data vector based on a different baryonic physics scenario as labeled in the legend. The legend also describes which baryonic mitigation techniques are applied, and how many PC modes are excluded or the HMcode parameters marginalized over.

need to remove up to 6 PCs for the 1σ posteriors to include the fiducial cosmological parameters.


### Method C is superior to methods A and D

In Fig. 12 we plot the w 0 bias (in color-filled markers; defined as |w 0,best fit − w 0,fid |, with w 0,best fit being the median value of the marginalized posterior distribution of w 0 ) and the 0.5σ error of w 0 (in open markers; with σ defined as the half difference between the 16th and 84th percentile of the 1D marginalized posterior of w 0 ) for various baryonic physics mitigation schemes. For a method to be effective in mitigating baryonic-induced parameter biases, we require that the bias be below the 0.5σ errors. For all baryonic physics scenarios, we observe that at fixed number of excluded PC modes, the biases of method C (red-solid triangles) are nearly always smaller than methods A (blue-solid circles) and D (yellow-solid squares). If focusing on the lower left panel of Fig. 11, using Illustris when removing 3 PC  Table 3. The darker colored-filled markers indicate the level of w 0 bias, defined as |w 0,best fit − w 0,fid |. The fainter unfilled markers indicate the 0.5σ statistical uncertainty, with 1σ defined as the half difference between the 16th and 84th quantiles of the marginalized 1D w 0 posterior distribution. We adopt a criterion of residual bias < 0.5σ error in this work when determining how many PC modes are required to mitigate biases due to baryonic physics. The four main lessons from this plot are that: i) Of various PCA methods, at fixed number of excluded PC modes, the biases of method C are nearly always smaller than methods A and D, indicating method C is the most efficient PCA method. ii) For MB2/Eagle/Horizon-AGN simulations, removing ≥ 2 PC modes is enough to mitigate baryonic physics-induced bias to 0.5σ. For the Illustris simulation, all PCA methods fail to pass the bias < 0.5σ criteria even after 9 PC modes are removed. iii) No matter which PCA method (A, C or D) is applied, after removing ≥ 6 PC modes, the statistical errors on w 0 converge to similar values. iv) HMcode works particularity well for the Illustris simulation. For MB2/Eagle/Horizon-AGN, marginalizing over both A and η 0 is required to safely mitigate baryons to 0.5σ.

modes as an examples, one can see that the 2D 1σ posteriors of method C (red dot-dashed curves) enclose the fiducial cosmology, while the posteriors of method A (light blue solid curves) are several σ away. Based on these, we conclude that PCs build from ∆ chy are potentially more effective than others to mitigate baryonic effects.

To understand why method C performs better, we can go back to the χ 2 equation when both D and M are set at p co,fid :
χ 2 bary = [D(p co,fid ) − M( p co,fid )] t C −1 [D( p co,fid ) − M(p co,fid )] = [D − M] t L −1 t L −1 [D − M] = [D ch − M ch ] t 1 [D ch − M ch ] .(33)
χ 2 bary quantifies the amount of χ 2 caused by baryonic uncertainties. Our goal is to reduce χ 2 bary to avoid bias in cosmological parameters due to baryonic physics. From Eq. (33) we immediately see why building the difference matrix using D ch − M ch instead of D − M leads to better results. Doing the latter omits information about the covariance matrix, and hence does not account for the noise properties of the data when constructing the PCs. PCs derived from ∆ chy are most effective in describing modifications of the data vector due to baryonic physics in terms of D ch − M ch , which is directly related to χ 2 bary . By design, when excluding PC modes, method C should be most effective in reducing χ 2 bary .


### Error bars converge for all PCA methods

Going back to Fig. 12, and focusing on the trend in the 0.5σ error bars of w 0 shown in open fainter-colored markers. Generally, error bars grow as more PC modes are excluded (see also Fig. 11 for the growth of error ellipse on 2D posteriors). The size of the error bars varies among the different PCA methods when fewer PC modes are excluded, but eventually converge/saturate to similar error bar sizes when excluding 6 PC modes, independent of how PCs are constructed. This means that the PCs fully absorb the range of matter power spectrum modifications due to baryonic physics across the nine OWLS simulation, characterizing them using 6 dominant degrees of freedom; the last 3 PC modes are subjected to very small singular values (σ as depicted in Fig. 6) such that only a tiny amount of baryonic fluctuation would be projected on them. In principle, including more training samples with different features would enrich the PC pool, increasing the number of effective degrees of freedom to characterize other possible baryonic scenarios.


## PCA framework versus HMcode

We now move to a more detailed comparison of the two main ways to marginalize over baryonic uncertainties, namely the PCA-based methods and the halo-model based approach. Since we already compared in §5.2 that of all PCA methods listed in Table 3, method C is more efficient than the other two in mitigating biases in cosmological parameters due to baryonic physics. In the following, we will use method C as a representative for PCA-based methods, and compare it with HMcode (method M).


### Comparison on the effectiveness (criterion: bias

< 0.5σ)

We begin by discussing the performance of HMcode when using only one (A) vs. two (both A and η 0 ) parameters to This implies that the current empirical relation described in Eq. (32) may not be precise enough for MB2/Eagle/Horizon-AGN-like data vectors with LSST-like statistical power. We therefore recommend that the extra freedom carried by η 0 is needed for upcoming weak lensing surveys to effectively mitigate the impact of baryonic physics on cosmological weak lensing measurements. This is even more true in light of recent findings that indicate that our Universe is not like Illustris, for which the AGN feedback is known to be too strong such that the baryon fractions in massive halos are too low compared with observations (Haider et al. 2016). In Fig. C1 of Appendix C, we also provide similar bias and error plots for other cosmological parameters: Ω m , σ 8 , and w a . The same conclusion holds for HMcode on these cosmological parameters (as shown in the filled and open pentagons), except for the w a constraint for Illustris (Fig. C1l), where varying only A is not enough to mitigate w a bias to within 0.5σ. For the PCA-based method C, as indicated in red triangles of Fig. 12 for w 0 and Fig. C1 for Ω m , σ 8 , and w a ), we find that removing ≥ 3 PC modes is sufficient to mitigate baryonic uncertainties to within 0.5σ for all cosmological parameters considered here, if our Universe has a baryonic physics scenarios like MB2/Eagle/Horizon-AGN.

For the case of the Illustris simulation, we find that the PCA method fails to mitigate baryonic biases to within 0.5σ for w 0 and Ω m (Fig. C1d), even after 9 PC modes are removed, but just passes the threshold for σ 8 (Fig. C1h) and w a (Fig. C1l) after removing 7 PC modes. We note that this is likely not a major concern as the baryonic effects of Illustris are unrealistically large, and the next generation Illus-trisTNG hydrodynamical simulation (Pillepich et al. 2018;Springel et al. 2018) will address the defects of the old version.

We provide a summary of the results from the above discussion in Table 4.


### Comparison on the level of degradation on cosmology

We now compare the error bars on cosmological parameter constraints between PCA method C and HMcode, on baryonic scenarios of MB2/Eagle/Horizon-AGN, where both methods successfully mitigate the baryonic biases to within 0.5σ. The pink open triangles in Fig. 12 indicate the 0.5σ error of w 0 under method C, and the gray open pentagons indicate the same for HMcode. Besides w 0 , other cosmological parameters are also shown in Fig. C1. As discussed in §5.2.2, one nice feature of the PCA method is that the error bars converge to a certain level when excluding ≥ 6 PC modes. We find that the converged error bars for method C generally are smaller than those for HMcode, even though HMcode only utilizes 2 parameters to marginalize over baryonic physics uncertainties while the PCA method needs 3 parameters to mitigate baryonic effects to 0.5σ in the case of MB2/Eagle/Horizon-AGN. A similar result can be seen from the 1σ 2D posteriors shown in Fig. 11.


### Baryonic feature constraint from HMcode

In Fig. 13, we plot the 2D posterior distributions on A and η 0 for various baryonic scenarios in colored contours, along with Eq. (32) shown in the black line. We can see that although relying on this A-η 0 relationship is not effective enough to mitigate baryonic bias in most of baryonic recipes under LSSTlike survey, the suggested relationship is still good enough to pass the 68% contours in all cases. Therefore, instead of following a fixed relationship like Eq. (32) or allowing both A and η 0 to vary unboundedly, setting an A-dependent prior on η 0 may help recover some cosmological constraining power while still reducing biases in cosmological parameters when using HMcode. Now that we have derived the best-fitted A and η 0 for various baryonic scenarios, as marked with the cross symbols in Fig. 13, we can compare the power spectra generated from HMcode at the best-fitted values of (A, η 0 ) to the original power spectra derived directly from the simulation data. In Fig. 14, the solid lines indicate best-fitted power spectra from HMcode, and the dotted or dashed lines are directly computed from hydro simulations at z = 0, 1, 2, 3. We note that this is not a fair comparison because the underlying P δ (k, z) is not constrainable from the projected tomographic power spectra, unless the tomographic bins are fine enough to recover the full 3D information. But we can use these plots to understand the effects of HMcode parameters on P δ (k, z). Firstly, HMcode does not have degrees of freedom for the cooling feature of hydro simulations, which leads to a turnover in the power spectrum ratio at k 10 h −1 Mpc. This is expected as according to M15, the halo-model power is accurate to ≈ 5% only for k ≤ 10 h −1 Mpc and z ≤ 2. Because of this limitation, HMcode tends to produce a shallower suppression of power for a given k (when k ≤ 10 h −1 Mpc) compared with MB2/Eagle/Horizon-AGN, in order to compensate for the lack of cooling prescription at k > 10 h −1 Mpc. Secondly, the redshift evolution of HMcode power spectra is too monotonic, lacking freedom to capture the complicated evolutionary pattern that generally exists in hydrodynamical simulations. The redshift evolution patterns can be very different for various baryonic scenarios. HMcode's inabil- Figure 13. The 2D constraints on the HMcode halo structure parameters A and η 0 from our simulated likelihood analysis for baryonic scenarios of Eagle (blue/solid), MB2 (red/dotted), Illustris (green/dot-dashed), and Horizon-AGN (yellow/dashed). The black line plots the relationship between A and η 0 that is used to provide single-parameter fit in HMcode. Both 68% and 95% confidence levels are shown. Table 5. Similar to Table 4, but now for the likelihood simulations with mock observables pushing to max ≈ 5000. ity to model redshift evolution may be due to the fact that only two nuisance parameters are involved in describing the complex scale and redshift dependences of baryonic effects seen in the simulations. One straightforward suggestions is to add redshift dependence to A and η 0 . Further development of halo model approaches to account for the modification of the matter power spectrum for k > 10 h −1 Mpc is also needed. Although the current model does not describe all the complexity of possible modifications of P(k) due to baryonic physics, we can still use HMcode to gain insight into the strength of feedback from the constrained values of A and η 0 . As shown in Fig. 13, the Illustris-like Universe tends to have small A and large η 0 .
1 . 6 2 . 4 3 . 2 4 . 0 4 . 8 A 0 . 5 0 . 6 0 . 7 0 . 8 0 . 9 η 0 Eagle MB2 Illustris Horizon-AGN η 0 = 0.98 − 0.12A

## Pushing to even smaller angular scales: max of 5000

Until now, all elements of our analysis have been based on mock tomographic shear data vectors with max ≈ 2000, which is a conservative choice under the limitation that  Figure 14. Comparisons of power spectra generated from HMcode at the best-fitted A and η 0 values (solid lines) and power spectra directly derived from hydrodynamical simulations (dotted or dashed lines) at z = 0, 1 , 2, 3. From the mismatch between solid and dashed curves, we see that HMcode lacks degrees of freedom to account for the cooling effect at high k, and that it is too simplified to capture the complex redshift evolution patterns present in hydrodynamical simulations.

we lack accurate power spectra at k > 30 h −1 Mpc. The max ≈ 2000 cut assures that various extrapolation curves on P δ (k) ratio out to k > 30 h −1 Mpc would not cause significant change on the resulting C i j ( ) data vector (see Appendix B for details on how the scale cut limit is determined).

To further test the limits of the proposed baryonic mitigation techniques, we generate mock C i j ( ) data vectors with max ≈ 5000 (based on the quadratic extrapolation trends derived by fitting the P δ (k) ratio in k ∈ [10, 30] h −1 Mpc, see the red curve in Fig. B1 as a demonstration), and then perform the same simulated likelihood analyses with mitigation techniques described in §3 and §4. The only difference is that we append 3 extra data points that with equal logarithmic spacing in ∈ [2060, 5000] to the original data vector D in each tomographic bin. The new length of D is thus extended to 55 × (18 + 3) = 1155 data points (see §3.2 for the original format of D). The covariance matrix is also updated accordingly.

The dark gray contours in Fig. 15 indicate the 2D posterior distributions of the cosmological parameters, when no baryonic physics mitigation technique is applied. Compared with the similar plot shown in Fig. 4, but for max ≈ 2000, the biases on cosmological parameters increases to 2σ ∼ 19σ for the various cosmological parameters in an Illustris-like Universe, and around 1.5σ ∼ 6σ for the other cases. This amount of bias is consistent with Fig. 5 of E15, who showed the posterior distributions for max ∼ 5000 for the OWLS baryonic physics scenarios for an LSST-like likelihood simulations.

Since we showed in §5.2 that method C is the most efficient of the PCA-based methods, we only run simulated likelihood analyses with PCA-based method C, compared with method M using HMcode for max ≈ 5000. In Fig. 16, we plot the marginalized w 0 bias (color-filled symbols) and 0.5σ w 0 uncertainty (open symbols) as a function of the number of excluded PC modes in method C (blue diamonds) and HMcode (yellow hexagons). (The red triangles and black pentagons are simply copies of the data points shown in Fig. 12, to enable easier comparison of results with max of 2000 versus 5000.) The bias and error plots for Ω m , σ 8 and w a are also provided in Fig. C1. Similar to §5.3, we rely on the bias < 0.5σ criterion to validate the effectiveness of baryonic physics mitigation methods, with the results summarized in Table 5. First of all, for HMcode, varying only A is not sufficient to mitigate the bias to within 0.5σ for the Illustris simulation, which HMcode is particularly good at describing. Both A and η 0 must be varied to meet our criterion for MB2 and Eagle. For Horizon-AGN and Illustris, HMcode works well for some cosmological parameters, while it fails for the others. For the PCA method, it still works for baryonic scenarios of MB2/Eagle/Horizon-AGN when pushing to max ≈ 5000, but continues to fail to meet our criterion for the Illustris scenario.

In terms of degradation on cosmological parameter constraints after marginalization, for the cases of MB2 and Eagle, the scenarios in which both PCA and HMcode succeed in mitigating the bias to within 0.5σ, we see that PCA method yields smaller converged error bars (light blue open diamonds) compared with HMcode using 2 parameters (yellow open hexagons) to do marginalization.

Does extending the data vectors to max ≈ 5000 help to better constrain cosmological parameters compared with max ≈ 2000? As shown in Fig. 12, for the PCA method, we observe that the converged w 0 errors for the max ≈ 5000 cases (light blue open diamonds) are smaller by ∼ 20% compared with the errors for max ≈ 2000 (pink open triangles). For the cases of HMcode when varying both A and η 0 , the w 0 errors reduce by ∼ 12% for MB2, ∼ 18% for Eagle, and ∼ 30% for Horizon-AGN, after extending data points to max ≈ 5000 (yellow open hexagons) from max ≈ 2000 (gray open pentagons). This means that we do benefit from additional constraining power when including more small-scale data in the analysis, if the baryonic physics effect in our Universe is near the physics implemented in Eagle/MB2/Horizon-AGN.


## Including more AGN prescriptions in the training set

The reason why the PCA method fails to mitigate the impact of baryonic physics on the matter power spectrum in Illustris is that the PCs built from the current training set do not capture the strong variation with k to explain its intense feedback feature. As also discussed in Mohammed & Gnedin (2017), it is better to have a training set that comprises adequately exotic but reasonable models. Of the nine training OWLS simulations, only the OWLS-AGN contains an AGN feedback prescription, and we rely on this single AGN model to explain Illustris. However, this shortcoming can be fixed by incorporating more training simulations into the PCA, so that the resulting PCs will include more degrees of freedom to explain the broader range of outcomes due to baryonic physics.

We try to address the above Illustris problem by including the baryonic scenarios of MB2/Eagle/Horizon-AGN in our training set, and then build a ∆ ch matrix with 12 columns to extend the capability of the derived PCs. In the bottom left panel of Fig. 16, we plot the marginalized w 0 bias (brown filled stars) and error (light brown open stars) for Illustris simulation with PCs trained from the 12 baryonic scenarios, and a scale cut at max ≈ 5000. (The results for other cosmological parameters can be found in the last column of Fig. C1 as well.) With this expanded training set, the PCA method now reduces the w 0 bias from 1.5σ (blue filled diamonds) to 0.8σ (brown filled stars), which is an improvement but still does not enable us to meet our criterion of bias < 0.5σ.

The error bars when using 12 simulations in the training set converge after removing ≥ 6 PC modes. Notice that the converged errors become bigger when the PCs are trained from 12 simulations rather than just the 9 OWLS simulations. By including more simulations to construct the PCs, we also enlarge the range of baryonic uncertainties, which is a trade-off to ensure a more effective removal of biases due to baryonic physics for a broad range of baryonic physics scenarios. However, we can also imagine trying to rely on external information from independent observations to rule out baryonic scenarios that fail to describe our Universe. By carefully controlling the uncertainty range of the train- and M (halo model-based method/HMcode) (see Table 3 for details). The darker colored-filled markers indicate the level of w 0 bias, defined as |w 0,best fit − w 0,fid |. The fainter colored-open markers indicate the 0.5σ w 0 uncertainty, with 1σ defined as the half difference between the 16th and 84th percentile of the marginalized 1D w 0 posterior distribution. The four key results on this plot are: i) the PCA method (blue diamonds) mitigates bias to within 0.5σ for the milder baryonic physics scenarios -MB2, Eagle, and Horizon-AGNafter excluding more than 3 PC modes, but fails for the Illustris scenario. ii) When marginalizing over both A and η 0 , HMcode (yellow hexagons) mitigates w 0 to within 0.5σ for all baryonic scenarios. ing set, we could potentially improve the cosmological constraining power after mitigation.


# SUMMARY AND DISCUSSION

We have explored the two major approaches to mitigate uncertainties in cosmic shear tomographic power spectra due to baryonic physics, with the goal of understanding their performance on cosmological constraints for the upcoming LSST survey. The first approach is the PCA-based analysis proposed by E15. Based on a set of training hydrodynamical simulations with various baryonic prescriptions (spanned by OWLS in this work), a difference matrix (Eq. (8)) is computed. Its columns are filled with difference vectors between these hydro and DMO simulations. PCA is then performed on the difference matrix to find dominant PC modes that can be used to model baryonic effects in other hydro simulations. The second approach is the halo model-based method coded in the package of HMcode by M15, which utilizes two halo structural parameters (A and η 0 ) related to the halo concentration-mass relation to marginalize over baryonic uncertainties.

We examine the basics of the PCA formalism and provide a modification to properly account for the change of covariance matrix after removal of PC modes. Under the new formalism, we demonstrate that PC mode removal is equivalent to marginalization over PC amplitudes (see §5.1). Instead of difference matrices, we also investigate PCA on other kinds of matrix forms with their columns filled with the fractional difference (Eq. (29)) or noise-weighted difference vectors (Eq. (26)) to quantify deviations in the matter power spectrum due to baryonic physics. The derived PC bases from different matrices vary in their efficiency in explaining baryon fluctuations at different angular scales. Difference matrix PCs can more effectively account for large scale baryonic fluctuations, fractional difference matrix PCs are more effective at describing the small scale fluctuations, and noise-weighted difference matrix PCs most effectively describe the scales at which the S/N is maximal. We find that performing PCA on the noise-weighted difference matrix, with the weighting factor derived via performing Cholesky decomposition on the covariance matrix ( §4.2), is the most efficient way to mitigate the impact of baryonic physics on inferred cosmological parameters ( §5.2). Therefore, for future application on real data, we recommend applying the noise-weighted PCA technique.It should be noted that except for method D, the current PCs are wiggling slightly in their directions at each MCMC step, when cosmology changes. If we would like to quantify baryon physics via PC amplitudes, we hope the constrained PC amplitudes are subjected to a fixed set of PCs. A more complete design of PCA algorithm therefore would be an iteration process. We will first use the current setting to find the best-fitted cosmology, and once the p co,best fit is determined, we will fix PC basis at p co,best fit , and constrain the posteriors of PC amplitudes subjected to this PC set.

We apply both the PCA and HMcode techniques on mock shear tomography data vectors (C i j ( )) with baryonic physics scenarios of MB2/Eagle/Illustris/Horizon-AGN. We test whether these mitigation techniques can reduce the bias in cosmological parameters induced by ne-glecting baryonic effects to within 0.5σ. With a scale cut at max ≈ 2000, and for milder baryonic physics scenarios like MB2/Eagle/Horizon-AGN, both methods succeed in mitigating the impact of baryonic effects on the inferred cosmological parameters. For the PCA method, we find that excluding 3 PC modes is sufficient to mitigate the bias to within 0.5σ for Ω m , σ 8 , w 0 and w a . For HMcode, we find that it is safer to vary both A and η 0 when performing marginalization, rather than varying only one of them and having the other follow the suggested relation in M15, at least at the level of LSST statistical power. For the Illustris scenario, only HMcode is sufficient to mitigate the bias to within 0.5σ. The PCA method fails to pass our criterion even after removing 9 PC modes. With a more aggressive max of 5000, the PCA methods still work for MB2/Eagle/Horizon-AGN, but fail for Illustris. HMcode remains sufficient for MB2/Eagle after marginalizing over 2 parameters but only works partially on some of the cosmological parameters for Horizon-AGN and Illustis, as summarized in Table 5.

Overall, HMcode is designed to describe the impact of baryonic physics on the matter power spectrum for k ≤ 10 h −1 Mpc, where the main feature is the suppression of power due to feedback (Fig. 1). Not surprisingly, we found that HMcode is most effective at mitigating the impact of baryonic physics for a strong feedback scenario like Illustris. Although the current version of HMcode lacks the complexity to fully describe various baryonic scenarios (Fig. 14), it provides a good summary of the level of feedback strength through two nuisance parameters (Fig. 13). Future improvements of the halo model to smaller scales of k ≥ 10 h −1 Mpc, as well as adding parameters to allow additional freedom in the redshift evolution of baryonic physics effects, may constrain halo structural parameters and baryonic power spectra ratio curve together with cosmology. Exploring the prior ranges on halo model parameters also help to improve cosmological parameter constraint. For example, we can use the posterior constraints from realistic hydrodynamical simulations as shown in Fig. 13 to narrow down the allowed ranges of A and η 0 . Joint constraints from galaxy-galaxy lensing together with cosmic shear may also provide additional information from the data itself on the halo structure parameters .

There are several advantages of the PCA method. Firstly, it successfully mitigates quite general baryonic fluctuations and complex redshift evolution patterns, when collecting several representative training hydrodynamical simulations to conduct PCA. The complex baryonic behaviors as well as the redshift evolution would then be naturally absorbed in only a few dominant PC modes, and we can use the amplitudes of these PC modes to perform marginalization (or, equivalently, PC mode exclusion). Secondly, the PCA method efficiently accounts for baryonic uncertainties without losing too much cosmological constraining power. As discussed in §5.3.2, whenever both methods are successful in removing baryonic bias, the error bars are generally smaller for PCA methods compared with the errors of HMcode. It is quite important to note that even if we do not know in advance how many PC modes must be excluded to safely remove baryonic bias in our Universe, excluding all effective PC modes does not unacceptably increase the errors, which saturate at a certain limit. The maximum number of effective PC modes one can remove is equal to the total number of training simulations used in the PCA (see §4.1.1 for detail). Finally, the PCA method has significant flexibility to make adjustments as our knowledge of baryonic physics improves. For example, in §5.4 we tried to improve the bias mitigation of the Illustris simulation by including more realistic baryonic scenarios with AGN prescriptions in our training set, which enriches the space of possible baryonic uncertainties that the PCs can describe. After the inclusion of MB2/Eagle/Horizon-AGN as well as the original 9 OWLS scenarios in our training set, we can further decrease the residual cosmological parameter bias compared with the results when only using the 9 OWLS simulations as training set. The cost is that we lose some constraining power. The flexibility of the PCA framework makes it easy to adjust the model based on changes in our knowledge of baryonic physics, and allows us to regulate errors by controlling the input training simulations in the PCA.

There are several aspects regarding the PCA framework that we do not explore within this work. Firstly, our training hydro simulations are all run under the flat ΛCDM model, and we assume that the baryonic fluctuations, as quantified in terms of power spectrum ratios between hydrodynamical and DMO simulations, remain fixed when cosmology changes. In reality, baryonic and cosmological effects vary jointly. Currently, there is no easy way to investigate this assumption, but future fast hydrodynamical simulations under development (Trac et al. in prep.) would be an ideal tool to systematically study this issue. Secondly, we adopted a power law extrapolation scheme for P δ (k) ratio at k ≥ 30 h −1 Mpc (see Appendix B). The most relevant physics that governs the high k behavior is the cooling and inner stellar density profile of galaxies. Current large-volume cosmological hydrodynamical simulations lack the resolution to resolve the physics of galaxy formation to galaxy centers. We rely on sub-grid models of feedback to avoid the overcooling of gas and to mitigate the differences between the observed and simulated galaxies, but discrepancies still exist (Stinson et al. 2010;Bottrell et al. 2017;Furlong et al. 2017). This implies that P δ (k) in the high k regime is still highly uncertain. Does the P δ (k) ratio continue the trend of increasing monotonically? Or should it reach a saturation point at some high k regime? How to properly propagate the uncertainties of the poorly understood small scale P δ (k) ratio into the errors of integrated C i j ( ) which in turn affects the derived PCs? These questions require higher resolution hydrodynamical simulations to further address. Finally, we have briefly demonstrated in §5.5 that depending on the training simulation set, the derived PCs carry different abilities to mitigate baryonic effects, and differ in the final constraining power. It would be worthwhile to systematically investigate various possible combinations of the training simulations, to find a most effective set of PCs that are able to span a wide enough range of baryonic uncertainties but with less degradation on constraining power.

In future extensions of this work, we will apply the PCA framework to a configuration-space tomographic shear analysis on real data to constrain the baryonic feature of our Universe and compare it with hydrodynamical simulations. We aim to develop a consistent way of quantifying priors of PC amplitudes, which would provide us with more constraining power on cosmological parameters by shrinking the allowed range of baryonic physics modifications of the mat-ter power spectrum. We will also develop a PCA tool for joint analysis of galaxy-galaxy lensing and galaxy clustering observables. The full 3×2-point analysis then can be selfconsistently analyzed within the PCA framework to increase the constraining power on cosmology while safely marginalizing over baryonic physics.

W(
x i ) = 1/∆L for |x i | < ∆L/2 0 else ,(A2)
where the grid cell side length ∆L = L box /1024, and the index i is the axies label of the Cartesian coordinate system. We then perform a discrete Fourier transform onδ(x) to derive its Fourier transformation pairδ(k):
δ(k) = δ(k)W(k) .(A3)
After the Fourier transform, the convolution operation in Eq. (A1) becomes a simple product, with W(k) being the Fourier space mass assignment window function:
W(k) = i W(k i ) = i sin ( k i ∆L 2 ) ( k i ∆L 2 ) ,(A4)
where k i (i = x, y, z) is the i-th component of k. The Fourier transformation pair of δ(x) then can be computed by
δ(k) =δ (k) W(k) .(A5)
We choose the convention of Fourier transform as δ(k) = ∫ dx δ(x)e −ik·x . Under this convention, the power spectrum can be estimated by averaging over all modes k with a length of k:
P δ (k) = 1 V box |δ(k)| 2 k= |k | ,(A6)
with V box being the box size of simulation. The raw estimation ofP δ (k) above is known to be affected by discreteness effects, which contributes into the power through a constant amplitude called shot noise
P shot = V box /N eff .(A7)
Here N eff is the effective number of particles, which accounts for their difference in mass:
N eff = (Σ N i m i ) 2 Σ N i m 2 i ,(A8)
where m i is the individual particle mass, and N is the total number of particles. For DMO simulations where all tracer particles have equal mass, N eff = N. The final power spectrum P δ (k) used throughout this work is derived after subtraction of the shot noise term:
P δ (k) =P δ (k) − P shot .(A9)

## APPENDIX B: POWER SPECTRUM RATIO

The power spectrum ratio between hydrodynamical and DMO simulations is an important quantity in this work. We rely on it in Eq.

(1) to derive mock observables at different cosmology, as well as to build difference matrices to perform PCA. Here we discuss the validity of our estimates of this ratio over the range of scales used throughout this work, and describe how we perform extrapolation to smaller scales than those that are well-described in the simulation.

B1 Discussion on the convergence of the power spectrum ratio

The ratios of matter power spectra that we use in this work are accurate over a range of k ∈ [0.1, 30] h −1 Mpc for Eagle/MB2/Illustris and of k ∈ [0.1, 10] h −1 Mpc for OWLS. Below we will justify this claim. The large scale limit is set by the simulation box size of order L box = 100 h −1 Mpc used in this work. Due to the small box effect, our power spectra at small k are sensitive to cosmic variance, and may suffer from an overall suppression of power due to missing modes that are unable to collapse properly (see Fig. 6  . However, since both hydro and DMO runs are set at exactly the same realization, we expect that the ratio of the matter power spectra at large scales should be robust against finite sampling scatter. For the relative comparisons of large scale suppressions in hydro vs. DMO simulations, they are estimated to be within 1% level agreement, according to a relevant discussion in Appendix A of Chisari et al. (2018).

The small scale limit of k is determined by the resolution of the simulation. For DMO simulations, Heitmann et al. (2010) pointed out that the P δ (k) values of different resolutions are within 1% agreement for k < k Ny /2, where the Nyquist wavenumber is set by the inter-particle separation on the initial grid:
k Ny = πN p L box ,(B1)
with N p being the cube-root of the total number of particles used in simulations. Typically there are two features of small scale deviation one would observe in P δ (k) for DMO runs, as shown in Fig. 8  . Firstly, a suppression of power for scales around k ∼ k Ny is found. This is due to discreteness effects in sampling small scale fluctuations. When fewer low-mass halos are resolved, P δ (k) is suppressed at small scales. The second effect is a steep rise of power at even larger k. This is believed to be caused by incorrect shot noise subtraction. Instead of assuming a constant shot noise as shown in Eq. (A7), shot noise should be scale dependent at small scales, which is not well modeled. On small scales, the convergence properties of hydrodynamical simulations are more difficult to systematically quantify due to the interplay between resolution effects and galaxy formation physics. For example, as the resolution increases, more lower mass halos are resolved, leading to an increased power of SN feedback. Subgrid parameters regulating SN feedback then must be modified to account for this effect in order to match the observables like galaxy stellar mass function. Typically subgrid prescriptions are designed to reach some level of convergence with the variation of resolution. However, the functionality of such self-regulation is rather limited. Eagle is currently the only hydro simulation with its subgrid model parameters re-calibrated to match observations when the resolution is changed (see Fig. 7 of Schaye et al. 2015). In the left-hand panel of Fig. A2 in van , they showed a convergence comparison between the power spectra of OWLS-REF hydro simulations with k Ny of 16 (the current OWLS resolution used in this work) and 32 respectively. The two baryonic power spectra agree to within ∼ 10% out to k ≈ 40 h −1 Mpc. We note that this statement only applies to OWLS-REF. There is no general rule on the behavior of convergence for hydro simulations, given that the galaxy observations are not yet converged, and that the subgrid prescriptions are all different.

We therefore assume that the computed P δ,hydro (k) from the highest resolution snapshot data to be accurate out to scale of k ≈ k Ny /2, which is the scale that is known to have 1% convergence for P δ,DMO (k). Accordingly, the power spectra ratio used in this work are assumed to be accurate within 1% of the range 0.1 < k < k Ny /2. We avoid using the naively derived power spectrum ratio for k > k Ny /2, because this will lead to overestimation of the power spectrum ratio due to the underestimation of the denominator of P δ,DMO (k) at scales of several times k Ny , and may lead to underestimation on the ratio toward even higher k due to the overestimation of P δ,DMO (k). We will introduce our extrapolation scheme below.


## B2 Power Spectrum Ratio Extrapolation Scheme

For scales below k < 0.1 h −1 Mpc, we simply let the ratio curve asymptotically approach one, which is a justifiable assumption since we know that baryons hardly modify the matter power spectrum on large scales. For small scales, as shown in Fig. 1, the power spectrum ratio between hydrodynamical and DMO simulations tends to increase after k 20 h −1 Mpc. This increase is caused by cooling effects in hydrodynamical simulation. In order to capture this physical effect, we make use of data points in k ∈ [10, 30] h −1 Mpc, perform a smooth quadric spline fitting in log(k)-log(P δ,bary (k)/P δ,DMO (k)) space, and extrapolating the fitted trend out to k > 30 h −1 Mpc. Figure 1 shows the extrapolation curves for all baryonic scenarios.

The above extrapolation scheme holds for Eagle/MB2/IIIustris/Horizon-AGN simulations, where we have reliable power spectrum ratios in the range k ∈ [10, 30] h −1 Mpc. For the OWLS simulation set, as discussed above, the ratio data is only well-determined for k ∈ [0.1, 10] h −1 Mpc. Even though the publicly released power spectrum data is available out to k ≈ 500, if we simply derive the ratio from the raw data, the small-scale results would be biased. The black line in Fig. B1 indicates the naively derived power spectrum ratio from the raw data of OWLS-AGN and OWLS-DMO. In the case of OWLS-AGN, we do need data points slightly beyond k of 10 h −1 Mpc to capture the transition from suppression to enhancement of power. We therefore still make use of the raw data points in the range of k ∈ [10, 30] h −1 Mpc, where the data uncertainties are estimated to be ≈ 10% (see our argument in §B1), to perform extrapolation spline line fitting, and the resulting curve is indicated in the red-dashed curve of Fig. B1. The raw data curve is slightly higher than the extrapolating curve when k is large. This may result from the underestimation of the DMO power spectrum as discussed in §B1. The extrapolation based on fitting data at k ∈ [10, 30] h −1 Mpc may exhibit uncertainties in the final extrapolation slope at high k. Therefore, we try to explore such uncertainties by setting slightly different extrapolating parameters that are shown as upper (yellow line) and lower (brown dot-dashed) bounds in Fig. B1. Finally, we also check the simplest constant extrapolation scheme as shown in the dark blue line. We will explore the effects of different extrapolation schemes on the resulting tomographic shear power spectra later.

If only using data points around k < 10 h −1 Mpc to perform smooth extrapolation, one would fail to capture the cooling effect that typically exists in hydrodynamical simulations at high k. The light blue dash-dot-dotted line of Fig. B1 indicates such an extrapolation based on the data points for k ∈ [3, 10] h −1 Mpc. This sets a very important requirement for our method. If we really want to use the PCA framework to achieve better cosmological parameter constraints by including more small scale information, the simulations that are used to build the PC basis must also have high enough resolution to construct a reasonable extrapolation down to the scale that goes into cosmological analysis. This is the reason why we avoid using the Rudd et al. (2008) and Gnedin et al. (2011) simulations to build our PC basis as in the previous work of E15. The half-Nyquist wavenumbers of these two simulations are too low to capture the up-turn in the power spectrum ratio, given the angular scales of ≈ 2000 used in this work.

We now justify how the choice of angular scale cut at ≈ 2000 is made. In Fig. B2 we present the computed tomographic shear power spectra in our lowest redshift bin, for various extrapolation schemes on the power spectra ratio shown in Fig. B1. The vertical gray line indicates the angular scale cut of = 2060 we have adopted. One can see that the C i j ( ) ratio only differs mildly at this scale. Therefore, although our current extrapolation scheme may lead to a considerable error in the P δ (k) ratio, after the integration process, such error propagation in C i j ( ) ratio is estimated to be within 10% when making an cut at ≈ 2000. We make a conservative choice of cutting in such that the final result is not too sensitive to our extrapolation scheme. In this Appendix, we provide constraints on cosmological parameters of Ω m , σ 8 , and w a after applying baryon mitigation techniques using HMcode or various PCA methods. The solid markers indicate the amount of residual bias after mitigation, and the open markers indicate the 0.5σ errors on the marginalized 1D posteriors. We rely on this plot to check whether a mitigation method can successfully reduce the baryonic physics-induced bias to within 0.5σ for different cosmological parameters and baryonic scenarios. The results are briefly summarized in Tables 4 and 5. We refer readers back to discussions at §5.3 and §5.4 for details. . The ratio of tomographic shear power spectrum between OWLS-AGN and OWLS-DMO simulations for our lowest tomographic bin. Curves in different colors represent different P δ (k) ratio extrapolation schemes as colored in Fig. B1. The vertical dashed line indicates the angular scale of = 2060, where the cut is made for all of tomography bins in our data vector. This cut is chosen such that the derived C i j ( ) curve would not be too sensitive on different P δ (k) ratio extrapolation schemes. 

## Figure 3 .
3The ratio of tomographic shear power spectra of different hydrodynamical simulations with respect to their counterpart DMO simulations for the lowest auto-correlation tomography bin with the cosmology set at the Planck 2015 result (


Hu & Jain 2004; Takada & Bridle 2007).

## Figure 4 .
4Cosmological parameter constraints for an LSST-like weak lensing survey with data vectors generated using various baryonic physics scenarios: pure DM (gray/solid) and the Eagle (blue/solid), MB2 (red/dashed), Illustris (yellow/dot-dashed) and Horizon-AGN (black/dotted) hydrodynamical simulations.

## Figure 7 .
7The effect of removing PC modes on the difference between DMO and hydrodynamical shear power spectra at fixed cosmology. Here the model vector M is produced at the same fiducial cosmology as the data vector D. The upper left panel shows the deviation between data and model, D − M, due to baryonic physics when constructing the data vector using various hydrodynamical simulations and the model vector using our DMO prescription in the lowest tomography bin. The thinner lines represent the nine OWLS baryonic scenarios, which are used to build the PCs. The thicker lines indicate our test simulation set of Eagle/MB2/Horizon-AGN/Illustris. As the number of excluded modes increases (left to right and top to bottom as indicated in each plot title), D and M become increasingly consistent at fixed cosmology.

## Figure 8 .
8The discrepancy between data and model vectors due to baryonic physics in terms of D ch − M ch for various hydrodynamical simulations in the lowest tomographic bin. This is similar to the upper left panel ofFig. 7, but here shows results for the case when applying Cholesky decomposition on our D and M vectors. The nine OWLS baryonic scenarios (thinner lines) compose columns of ∆ ch , which are used to build PCs. These PCs are used to span the variation of Eagle/MB2/Illustris/Horizon-AGN simulations in D ch − M ch space. After Cholesky decomposition, the largest data-model inconsistency shifts to smaller scales compared with the upper left panel ofFig. 7, indicating the PCs trained from ∆ ch are more efficient at describing small-scale variations in the matter power spectrum due to baryonic physics compared with performing PCA on ∆.

## For example ,
,Joudaki et al. (2017) applied only varying A to marginalize over baryonic physics in CFHTLenS cosmic shear, while MacCrann et al.(2017)andTroxel et al. (2017) varied both parameters to marginalize over baryonic physics in the Dark Energy Survey (DES).

## Figure 9 .
9Comparison of the posterior distributions of cosmological parameters between baryonic physics mitigation techniques A & B listed in

## Figure 10 .
10Marginalized 1D constraints on cosmological parameters when using different baryonic physics mitigation techniques from

## Figure 12 .
12The w 0 bias and statistical uncertainty under various baryonic physics mitigation techniques listed in

## Figure 15 .
15Similar toFig. 4, but for the cases when pushing our mock observables toward max ≈ 5000.

## Figure 16 .
16chy 12 sim)bias [`m ax ⇠ 5000] C ( chy 12 sim)error [`m ax ⇠ 5000] The w 0 bias and uncertainty for the baryonic physics mitigation methods C (as our representative for PCA-based method)


of Heitmann et al. 2010 for DMO sims and Fig. A1 of van Daalen et al. 2011 for OWLS hydro sims)


of Heitmann et al. (2010) (or a similar Fig. A3 in van Daalen et al. (2011) for the OWLS-DMO simulation)

## Figure B1 .
B1Power spectrum ratio between OWLS-AGN and OWLS-DMO at z = 0, assuming different extrapolation schemes above k > 10 h −1 Mpc. The black line shows the raw data calculated by simply taking ratio from the raw OWLS power spectra from van Daalen et al. (2011). The red dashed line indicates the extrapolation scheme by extending a quadric spline fitted curve using the raw data points in k ∈ [10, 30] h −1 Mpc. The yellow and brown dot-dashed lines indicate the two possible upper and lower bounds one may derive, if there is some uncertainty in the raw data points k ∈ [10, 30] h −1 Mpc. The dark blue line plots a pure flat extrapolation. The light blue dash-dot-dotted line indicates the case of extrapolation when using data points in k ∈ [3, 10] h −1 Mpc, which are believed to be well-measured. APPENDIX C: CONSTRAINTS ON COSMOLOGICAL PARAMETERS OF Ω m , σ 8 , AND w a

## Figure B2
B2Figure B2. The ratio of tomographic shear power spectrum between OWLS-AGN and OWLS-DMO simulations for our lowest tomographic bin. Curves in different colors represent different P δ (k) ratio extrapolation schemes as colored in Fig. B1. The vertical dashed line indicates the angular scale of = 2060, where the cut is made for all of tomography bins in our data vector. This cut is chosen such that the derived C i j ( ) curve would not be too sensitive on different P δ (k) ratio extrapolation schemes.

## Figure C1 .
C1Similar to Fig. 16, but for cosmological parameters of Ω m (first row), σ 8 (second row) and w a (third row), for various baryonic scenarios categorized in each different column.


): {Ω m , Ω b , Ω Λ , σ 8 , n s , h} = {0.2726, 0.0456, 0.7274, 0.809, 0.963, 0.704}.Illustris incorporates a broad range of galaxy formationTable 1. Basic information for the hydrodynamical simulations used in this work.Simulation 
Box Length 
Total 
DM particle 
initial gas force softening 
cosmology 
Particle # 
mass 
particle mass 
length 
OWLS 
100 h −1 Mpc 
2 × 512 3 
4.06 × 10 8 h −1 M 
8.66 × 10 7 h −1 M 
0.78 h −1 kpc 
WMAP3 
MassiveBlack-II 
100 h −1 Mpc 
2 × 1972 3 
1.1 × 10 7 h −1 M 
2.2 × 10 6 h −1 M 
1.85 h −1 kpc 
WMAP7 
Illustris 
75 h −1 Mpc 
2 × 1820 3 
4.41 × 10 6 h −1 M 
8.87 × 10 5 h −1 M 
1.4 h −1 kpc 
WMAP7 
Eagle 
67.77 h −1 Mpc 
2 × 1504 3 
6.57 × 10 6 h −1 M 
1.23 × 10 6 h −1 M 
1.8 h −1 kpc 
Planck2013 
Horizon-AGN 
100 h −1 Mpc 
2 × 1024 3 
1.1 × 10 7 h −1 M 
2.2 × 10 6 h −1 M 
1.85 h −1 kpc 
WMAP7 




77 h −1 Mpc (comoving). There are 1504 3 DM particles in both hydrodynamical and DMO simulations, and an approximately equal number of baryonic particles in the hydrodynamical run. The mass of each DM particle is 6.57 × 10 6 h −1 M and the initial baryonic mass resolution is 1.23 × 10 6 h −1 M . The gravitational softening length is = 1.8 h −1 kpc in comoving units (The EAGLE team 2017). The cosmological parameters used in Eagle are consistent with Planck 2013 results (Planck Collaboration et al. 2014): {Ω m , Ω b , Ω Λ , σ 8 , n s , h} = {0.307, 0.04825, 0.693, 0.8288, 0.9611, 0.6777}.


). Simulations without SN feedback (NOSN, NOSN NOZCOOL) tend to have an even stronger increase in power compared to the reference simulation REF. When adding AGN feedback to REF, the power is suppressed dramatically, with 1% reduction for k ≈ 0.3 h −1 Mpc and exceeding 10% for k 2 h −1 Mpc (van Daalen et al. 2011). The suppression of power is due to baryons being pushed outward by the energetic AGN feedback processes.The thick lines represent power spectra ratio for Eagle, MB2, Illustris and Horizon-AGN simulations. Although they all involve a broad range of astrophysical processes that are believed to be relevant to galaxy formation, the result-Figure 1. The ratios of the matter power spectra in different hydrodynamical simulations with respect to their counterpart DMO simulations at z = 0. The thick lines show results for the Eagle, MB2 and Illustris simulations, while the thin lines indicate the 9 different baryonic scenarios in OWLS simulation suite. The gray vertical line separates between regions where the data points come from direct measurement (k 30 h −1 Mpc) and from extrapolation with a quadratic spline fit (k 30 h −1 Mpc; see Appendix B for further details).10 −1 
10 0 
10 1 
10 2 
k [Mpc −1 h] 

0.6 

0.8 

1.0 

1.2 

1.4 

1.6 

1.8 

P hydro 

δ 

(k)/P DMO 

δ 

(k) 

z = 0 

Eagle 
MB2 
Horizon-AGN 
Illustris 
AGN 
DBLIMFV1618 
NOSN 

NOSN NOZCOOL 
NOZCOOL 
REF 
WDENS 
WML1V848 
WML4 
DMO 



## Table 2 )
2. The 


## Table 4 .
4Summary of the effectiveness of baryonic physics mitiga-AGN, we find that varying only A while setting η 0 following Eq. (32) is not sufficient to mitigate baryonic bias.tion methods in reducing biases to within 0.5σ for various cosmo-
logical parameters under different baryonic scenarios. A cosmo-
logical parameter is struck out if a mitigation method fails to pass 
our criterion of bias < 0.5σ, where σ represents the marginalized 
statistical error (see  §5.3.1 for detail). 

MB2/Eagle/Horizon-AGN 
Illustris 
HMcode (A) 
all fail 
Ω m σ 8 w 0 

& & 

w a 
HMcode (A, η 0 ) 
all pass 
all pass 
PCA (trained by 9 sims) 
all passΩ m σ 8 

& & 

w 0 w a 

marginalize over baryonic physics. When only the parame-
ter A is used, HMcode sets the η 0 value via Eq. (32). Go-
ing back to Fig. 12, with w 0 as an example, the pentagons 
at an x-axis value of 1 indicate the bias (black-solid) and 
0.5σ error (gray-open) of only varying A in HMcode. Sim-
ilarly, the pentagons at an x-axis value of 2 indicate the 
option for HMcode varying both A and η 0 . For the Illustris 
simulation, both options can successfully mitigate the bary-
onic bias on w 0 to within our 0.5σ criterion. However, apart 
from Illustris, for the baryonic scenarios of MB2, Eagle, and 
Horizon-
https://github.com/alexander-mead/HMcode MNRAS 000, 1-30 (2018)
MNRAS 000, 1-30(2018)
ACKNOWLEDGEMENTSAPPENDIX A: POWER SPECTRUM COMPUTATIONHere we describe the practical implementation of our power spectrum computation from the simulation snapshots. The matter density field in the Universe can be quantified via the overdensity δ(x), defined as δ(x) = ρ(x)−ρ ρ , where ρ(x) specifies the density function at position x andρ is the global mean density. We first estimate δ(x) on a uniform grid of 1024 cells across a side of the simulation box with the particle deposition step carried out via Nearest Grid Point (NGP) assignment. Our estimator iŝHere the mass assignment function can be described byThis paper has been typeset from a T E X/L A T E X file prepared by the author.
. F Bernardeau, S Colombi, E Gaztañaga, R Scoccimarro, 10.1016/S0370-1573(02)00135-7Phys. Rep. 3671Bernardeau F., Colombi S., Gaztañaga E., Scoccimarro R., 2002, Phys. Rep., 367, 1

. G R Blumenthal, S M Faber, R Flores, J R Primack, 10.1086/163867ApJ. 30127Blumenthal G. R., Faber S. M., Flores R., Primack J. R., 1986, ApJ, 301, 27

. C M Booth, J Schaye, 10.1111/j.1365-2966.2009.15043.xMNRAS. 39853Booth C. M., Schaye J., 2009, MNRAS, 398, 53

. C Bottrell, P Torrey, L Simard, S L Ellison, 10.1093/mnras/stx276MNRAS. 4672879Bottrell C., Torrey P., Simard L., Ellison S. L., 2017, MNRAS, 467, 2879

. G Chabrier, 10.1086/376392PASP. 115763Chabrier G., 2003, PASP, 115, 763

. C Chang, 10.1093/mnras/stt1156MNRAS. 4342121Chang C., et al., 2013, MNRAS, 434, 2121

. N E Chisari, 10.1086/321376arXiv:1801.08559ApJ. 55456preprintChisari N. E., et al., 2018, preprint, (arXiv:1801.08559) Cooray A., Hu W., 2001, ApJ, 554, 56

. A Cooray, R Sheth, 10.1016/S0370-1573(02)00276-4Phys. Rep. 3721Cooray A., Sheth R., 2002, Phys. Rep., 372, 1

. D Copeland, A Taylor, A Hall, arXiv:1712.07112preprintCopeland D., Taylor A., Hall A., 2017, preprint, (arXiv:1712.07112)

. W Cui, S Borgani, G Murante, 10.1093/mnras/stu673MNRAS. 4411769Cui W., Borgani S., Murante G., 2014, MNRAS, 441, 1769

. B Dai, Y Feng, U Seljak, arXiv:1804.00671preprintDai B., Feng Y., Seljak U., 2018, preprint, (arXiv:1804.00671)

. Di Matteo, T Springel, V Hernquist, L , 10.1038/nature03335Nature. 433604Di Matteo T., Springel V., Hernquist L., 2005, Nature, 433, 604

. Y Dubois, 10.1093/mnras/stu1227MNRAS. 4441453Dubois Y., et al., 2014, MNRAS, 444, 1453

. T Eifler, 10.1111/j.1365-2966.2011.19502.xMNRAS. 418536Eifler T., 2011, MNRAS, 418, 536

. T Eifler, P Schneider, J Hartlap, 10.1051/0004-6361/200811276A&A. 502721Eifler T., Schneider P., Hartlap J., 2009, A&A, 502, 721

. T Eifler, E Krause, P Schneider, K Honscheid, 10.1093/mnras/stu251MNRAS. 4401379Eifler T., Krause E., Schneider P., Honscheid K., 2014, MNRAS, 440, 1379

. T Eifler, E Krause, S Dodelson, A R Zentner, A P Hearin, N Y Gnedin, 10.1093/mnras/stv2000MNRAS. 4542451Eifler T., Krause E., Dodelson S., Zentner A. R., Hearin A. P., Gnedin N. Y., 2015, MNRAS, 454, 2451

. D Foreman-Mackey, D W Hogg, D Lang, J Goodman, 10.1086/670067PASP. 125306Foreman-Mackey D., Hogg D. W., Lang D., Goodman J., 2013, PASP, 125, 306

. M Furlong, 10.1093/mnras/stw2740MNRAS. 465722Furlong M., et al., 2017, MNRAS, 465, 722

. B Giblin, arXiv:1805.12084preprintGiblin B., et al., 2018, preprint, (arXiv:1805.12084)

. N Y Gnedin, A V Kravtsov, D H Rudd, 10.1088/0067-0049/194/2/46ApJS. 19446Gnedin N. Y., Kravtsov A. V., Rudd D. H., 2011, ApJS, 194, 46

. J Goodman, J Weare, Communications in applied mathematics and computational science. 565Goodman J., Weare J., et al., 2010, Communications in applied mathematics and computational science, 5, 65

. M Haider, D Steinhauser, M Vogelsberger, S Genel, V Springel, P Torrey, L Hernquist, 10.1093/mnras/stw077MNRAS. 4573024Haider M., Steinhauser D., Vogelsberger M., Genel S., Springel V., Torrey P., Hernquist L., 2016, MNRAS, 457, 3024

. J Harnois-Déraps, L Van Waerbeke, M Viola, C Heymans, 10.1093/mnras/stv646MNRAS. 4501212Harnois-Déraps J., van Waerbeke L., Viola M., Heymans C., 2015, MNRAS, 450, 1212

. A P Hearin, A R Zentner, Z Ma, 10.1088/1475-7516/2012/04/034J. Cosmology Astropart. Phys. 434Hearin A. P., Zentner A. R., Ma Z., 2012, J. Cosmology Astropart. Phys., 4, 034

. K Heitmann, M White, C Wagner, S Habib, D Higdon, 10.1088/0004-637X/715/1/104ApJ. 715104Heitmann K., White M., Wagner C., Habib S., Higdon D., 2010, ApJ, 715, 104

. K Heitmann, E Lawrence, J Kwan, S Habib, D Higdon, 10.1088/0004-637X/780/1/111ApJ. 780111Heitmann K., Lawrence E., Kwan J., Habib S., Higdon D., 2014, ApJ, 780, 111

. W Hu, B Jain, 10.1103/PhysRevD.70.043009Phys. Rev. D. 7043009Hu W., Jain B., 2004, Phys. Rev. D, 70, 043009

. D Huterer, M Takada, 10.1016/j.astropartphys.2005.02.006Astroparticle Physics. 23369Huterer D., Takada M., 2005, Astroparticle Physics, 23, 369

. S Joudaki, 10.1093/mnras/stw2665MNRAS. 4652033Joudaki S., et al., 2017, MNRAS, 465, 2033

. N Khandai, Di Matteo, T Croft, R Wilkins, S Feng, Y Tucker, E Degraf, C Liu, M.-S , 10.1093/mnras/stv627MNRAS. 4501349Khandai N., Di Matteo T., Croft R., Wilkins S., Feng Y., Tucker E., DeGraf C., Liu M.-S., 2015, MNRAS, 450, 1349

. E Komatsu, 10.1088/0067-0049/192/2/18ApJS. 19218Komatsu E., et al., 2011, ApJS, 192, 18

. E Krause, T Eifler, 10.1093/mnras/stx1261MNRAS. 4702100Krause E., Eifler T., 2017, MNRAS, 470, 2100

. E Krause, arXiv:1706.09359preprintKrause E., et al., 2017, preprint, (arXiv:1706.09359)

. Lawrence E , 10.3847/1538-4357/aa86a9ApJ. 84750Lawrence E., et al., 2017, ApJ, 847, 50

. N Maccrann, 10.1093/mnras/stw2849MNRAS. 4652567MacCrann N., et al., 2017, MNRAS, 465, 2567

. R Mandelbaum, arXiv:1710.03235preprintMandelbaum R., 2017, preprint, (arXiv:1710.03235)

. D Martizzi, R Teyssier, B Moore, T Wentz, 10.1111/j.1365-2966.2012.20879.xMonthly Notices of the Royal Astronomical Society. 4223081Martizzi D., Teyssier R., Moore B., Wentz T., 2012, Monthly Notices of the Royal Astronomical Society, 422, 3081

. A J Mead, J A Peacock, C Heymans, S Joudaki, A F Heavens, 10.1093/mnras/stv2036MNRAS. 454Mead A. J., Peacock J. A., Heymans C., Joudaki S., Heavens A. F., 2015, MNRAS, 454, 1958

. A J Mead, C Heymans, L Lombriser, J A Peacock, O I Steele, H A Winther, 10.1093/mnras/stw681MNRAS. 4591468Mead A. J., Heymans C., Lombriser L., Peacock J. A., Steele O. I., Winther H. A., 2016, MNRAS, 459, 1468

. I Mohammed, N Y Gnedin, arXiv:1707.02332preprintMohammed I., Gnedin N. Y., 2017, preprint, (arXiv:1707.02332)

. I Mohammed, D Martizzi, R Teyssier, A Amara, arXiv:1410.6826preprintMohammed I., Martizzi D., Teyssier R., Amara A., 2014, preprint, (arXiv:1410.6826)

. C B Morrison, M D Schneider, 10.1088/1475-7516/2013/11/009J. Cosmology Astropart. Phys. 119Morrison C. B., Schneider M. D., 2013, J. Cosmology Astropart. Phys., 11, 009

. B O Mummery, I G Mccarthy, S Bird, J Schaye, 10.1093/mnras/stx1469471227MN-RASMummery B. O., McCarthy I. G., Bird S., Schaye J., 2017, MN- RAS, 471, 227

. J F Navarro, C S Frenk, S D M White, 10.1086/177173ApJ. 462563Navarro J. F., Frenk C. S., White S. D. M., 1996, ApJ, 462, 563

. D Nelson, 10.1016/j.ascom.2015.09.003Astronomy and Computing. 1312Nelson D., et al., 2015, Astronomy and Computing, 13, 12

. K Osato, M Shirasaki, N Yoshida, 10.1088/0004-637X/806/2/186ApJ. 806186Osato K., Shirasaki M., Yoshida N., 2015, ApJ, 806, 186

. J A Peacock, R E Smith, 10.1046/j.1365-8711.2000.03779.xMNRAS. 3181144Peacock J. A., Smith R. E., 2000, MNRAS, 318, 1144

. S Perlmutter, 10.1086/307221ApJ. 517565Perlmutter S., et al., 1999, ApJ, 517, 565

. A Pillepich, 10.1093/mnras/stx2656MNRAS. 4734077Pillepich A., et al., 2018, MNRAS, 473, 4077

. 10.1051/0004-6361/201321591A&A. 57116Planck Collaboration et al., 2014, A&A, 571, A16

. 10.1051/0004-6361/201525830A&A. 59413Planck Collaboration et al., 2016, A&A, 594, A13

. Y Rasera, R Teyssier, 10.1051/0004-6361:20053116A&A. 4451Rasera Y., Teyssier R., 2006, A&A, 445, 1

. A G Riess, 10.1086/300499AJ. 1161009Riess A. G., et al., 1998, AJ, 116, 1009

. D H Rudd, A R Zentner, A V Kravtsov, 10.1086/523836ApJ. 67219Rudd D. H., Zentner A. R., Kravtsov A. V., 2008, ApJ, 672, 19

. M Sato, T Hamana, R Takahashi, M Takada, N Yoshida, T Matsubara, N Sugiyama, 10.1088/0004-637X/701/2/945ApJ. 701945Sato M., Hamana T., Takahashi R., Takada M., Yoshida N., Mat- subara T., Sugiyama N., 2009, ApJ, 701, 945

. J Schaye, 10.1111/j.1365-2966.2009.16029.xMNRAS. 4021536Schaye J., et al., 2010, MNRAS, 402, 1536

. J Schaye, 10.1093/mnras/stu2058MNRAS. 446521Schaye J., et al., 2015, MNRAS, 446, 521

. U Seljak, 10.1046/j.1365-8711.2000.03715.xMNRAS. 318203Seljak U., 2000, MNRAS, 318, 203

. E Semboloni, H Hoekstra, J Schaye, M P Van Daalen, I G Mc-Carthy, 10.1111/j.1365-2966.2011.19385.xMNRAS. 4172020Semboloni E., Hoekstra H., Schaye J., van Daalen M. P., Mc- Carthy I. G., 2011, MNRAS, 417, 2020

. E Semboloni, H Hoekstra, J Schaye, 10.1093/mnras/stt1013MNRAS. 434148Semboloni E., Hoekstra H., Schaye J., 2013, MNRAS, 434, 148

. S F Shandarin, Y B Zeldovich, 10.1103/RevModPhys.61.185Reviews of Modern Physics. 61185Shandarin S. F., Zeldovich Y. B., 1989, Reviews of Modern Physics, 61, 185

. F Simpson, J B James, A F Heavens, C Heymans, 10.1103/PhysRevLett.107.271301Physical Review Letters. 107271301Simpson F., James J. B., Heavens A. F., Heymans C., 2011, Phys- ical Review Letters, 107, 271301

. F Simpson, A F Heavens, C Heymans, 10.1103/PhysRevD.88.083510Phys. Rev. D. 8883510Simpson F., Heavens A. F., Heymans C., 2013, Phys. Rev. D, 88, 083510

. R E Smith, 10.1046/j.1365-8711.2003.06503.xMNRAS. 3411311Smith R. E., et al., 2003, MNRAS, 341, 1311

. D N Spergel, 10.1086/513700ApJS. 170377Spergel D. N., et al., 2007, ApJS, 170, 377

. V Springel, L Hernquist, 10.1046/j.1365-8711.2003.06206.xMNRAS. 339289Springel V., Hernquist L., 2003, MNRAS, 339, 289

. V Springel, Di Matteo, T Hernquist, L , 10.1111/j.1365-2966.2005.09238.xMNRAS. 361776Springel V., Di Matteo T., Hernquist L., 2005, MNRAS, 361, 776

. V Springel, 10.1093/mnras/stx3304MNRAS. 475676Springel V., et al., 2018, MNRAS, 475, 676

. G S Stinson, J Bailin, H Couchman, J Wadsley, S Shen, S Nickerson, C Brook, T Quinn, 10.1111/j.1365-2966.2010.17187.xMonthly Notices of the Royal Astronomical Society. 408812Stinson G. S., Bailin J., Couchman H., Wadsley J., Shen S., Nick- erson S., Brook C., Quinn T., 2010, Monthly Notices of the Royal Astronomical Society, 408, 812

. R S Sutherland, M A Dopita, 10.1086/191823ApJS. 88253Sutherland R. S., Dopita M. A., 1993, ApJS, 88, 253

. M Takada, S Bridle, 10.1088/1367-2630/9/12/446New Journal of Physics. 9446Takada M., Bridle S., 2007, New Journal of Physics, 9, 446

. M Takada, B Jain, 10.1111/j.1365-2966.2009.14504.xMNRAS. 3952065Takada M., Jain B., 2009, MNRAS, 395, 2065

. R Takahashi, M Sato, T Nishimichi, A Taruya, M Oguri, 10.1088/0004-637X/761/2/152ApJ. 761152Takahashi R., Sato M., Nishimichi T., Taruya A., Oguri M., 2012, ApJ, 761, 152

. A Tenneti, R Mandelbaum, Di Matteo, T Kiessling, A Khandai, N , 10.1093/mnras/stv1625MNRAS. 453469Tenneti A., Mandelbaum R., Di Matteo T., Kiessling A., Khandai N., 2015, MNRAS, 453, 469

. M A Troxel, arXiv:1708.01538preprintTroxel M. A., et al., 2017, preprint, (arXiv:1708.01538)

. M Velliscig, M P Van Daalen, J Schaye, I G Mccarthy, M Cacciato, A M C Le Brun, Dalla Vecchia, C , 10.1093/mnras/stu1044MNRAS. 4422641Velliscig M., van Daalen M. P., Schaye J., McCarthy I. G., Cac- ciato M., Le Brun A. M. C., Dalla Vecchia C., 2014, MNRAS, 442, 2641

. M Vogelsberger, S Genel, D Sijacki, P Torrey, V Springel, L Hernquist, 10.1093/mnras/stt1789MNRAS. 4363031Vogelsberger M., Genel S., Sijacki D., Torrey P., Springel V., Hernquist L., 2013, MNRAS, 436, 3031

. M Vogelsberger, 10.1093/mnras/stu1536MNRAS. 4441518Vogelsberger M., et al., 2014, MNRAS, 444, 1518

. D H Weinberg, M J Mortonson, D J Eisenstein, C Hirata, A G Riess, E Rozo, 10.1016/j.physrep.2013.05.001Phys. Rep. 53087Weinberg D. H., Mortonson M. J., Eisenstein D. J., Hirata C., Riess A. G., Rozo E., 2013, Phys. Rep., 530, 87

. A R Zentner, D H Rudd, W Hu, 10.1103/PhysRevD.77.043507Phys. Rev. D. 7743507Zentner A. R., Rudd D. H., Hu W., 2008, Phys. Rev. D, 77, 043507

. A R Zentner, E Semboloni, S Dodelson, T Eifler, E Krause, A P Hearin, 10.1103/PhysRevD.87.043509Phys. Rev. D. 8743509Zentner A. R., Semboloni E., Dodelson S., Eifler T., Krause E., Hearin A. P., 2013, Phys. Rev. D, 87, 043509

. M P Van Daalen, J Schaye, C M Booth, Dalla Vecchia, C , 10.1111/j.1365-2966.2011.18981.xMNRAS. 4153649van Daalen M. P., Schaye J., Booth C. M., Dalla Vecchia C., 2011, MNRAS, 415, 3649